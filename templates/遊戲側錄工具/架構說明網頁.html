<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Dump Tool 系統架構說明</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.0/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #8e44ad;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--gradient-primary);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: var(--gradient-secondary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.3em;
            font-weight: 300;
            margin-bottom: 20px;
        }
        
        /* Navigation */
        .nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        
        .nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .nav a {
            text-decoration: none;
            color: var(--primary-color);
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 2px solid transparent;
        }
        
        .nav a:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            color: var(--primary-color);
            font-size: 2.2em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card h3 {
            color: var(--secondary-color);
            font-size: 1.5em;
            margin: 25px 0 15px 0;
            padding-left: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .card h4 {
            color: var(--info-color);
            font-size: 1.2em;
            margin: 20px 0 10px 0;
        }
        
        /* Icons */
        .icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
        
        /* Mermaid diagrams */
        .mermaid {
            text-align: center;
            margin: 30px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Code blocks */
        .code-container {
            position: relative;
            margin: 20px 0;
        }
        
        .code-header {
            background: var(--dark-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 10px 10px 0 0;
            font-weight: 500;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        pre[class*="language-"] {
            margin: 0 !important;
            border-radius: 0 0 10px 10px !important;
            box-shadow: var(--shadow);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        th {
            background: var(--gradient-primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        /* Feature grids */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-item {
            background: var(--gradient-success);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .feature-item:hover {
            transform: translateY(-5px);
        }
        
        .feature-item h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        /* Architecture components */
        .arch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .arch-component {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .arch-component:hover {
            transform: translateX(5px);
            border-left-color: var(--accent-color);
        }
        
        .arch-component h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .arch-component ul {
            margin-left: 20px;
        }
        
        .arch-component li {
            margin: 5px 0;
            color: #666;
        }
        
        /* Process steps */
        .process-flow {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .process-step {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            min-width: 200px;
            position: relative;
        }
        
        .process-step::after {
            content: '→';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: var(--secondary-color);
        }
        
        .process-step:last-child::after {
            display: none;
        }
        
        .step-number {
            background: var(--gradient-primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 15px auto;
        }
        
        /* Alert boxes */
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid var(--info-color);
        }

        /* 圖片和影片樣式 */
        .media-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .media-container img,
        .media-container video {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .media-container img:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .media-container video {
            border-radius: 12px;
            max-height: 70vh;
        }
        
        .media-caption {
            margin-top: 10px;
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .media-container img,
            .media-container video {
                margin: 5px;
                border-radius: 6px;
            }
        }
            border-left: 5px solid;
        }
        
        .alert-info {
            background: #e8f4f8;
            border-color: var(--info-color);
            color: #5a5a5a;
        }
        
        .alert-warning {
            background: #fef9e7;
            border-color: var(--warning-color);
            color: #5a5a5a;
        }
        
        .alert-success {
            background: #e8f5e8;
            border-color: var(--success-color);
            color: #5a5a5a;
        }
        
        .alert-danger {
            background: #ffeaea;
            border-color: var(--accent-color);
            color: #5a5a5a;
        }
        
        /* Technology stack */
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .tech-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            border-top: 3px solid var(--secondary-color);
        }
        
        .tech-item h5 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .tech-item .version {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .tech-item .purpose {
            color: #666;
            font-size: 0.9em;
        }
        
        /* API endpoints */
        .api-endpoint {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--success-color);
        }
        
        .api-method {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
        }
        
        .api-method.get {
            background: var(--success-color);
        }
        
        .api-method.post {
            background: var(--info-color);
        }
        
        .api-method.ws {
            background: var(--warning-color);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav ul {
                flex-direction: column;
                align-items: center;
            }
            
            .feature-grid,
            .arch-grid {
                grid-template-columns: 1fr;
            }
            
            .process-flow {
                flex-direction: column;
                align-items: center;
            }
            
            .process-step::after {
                content: '↓';
                right: 50%;
                top: 100%;
                transform: translateX(50%);
            }
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Loading animation for mermaid */
        .mermaid-loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏗️ Game Dump Tool 系統架構說明</h1>
            <p class="subtitle">分散式遊戲數據收集與分析系統</p>
            <div class="alert alert-info">
                <strong>系統概述：</strong>基於 Chrome Extension + Python 後端的模組化架構，專為 PG Slot 遊戲數據收集設計
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <ul>
                <li><a href="#overview">🎯 架構概覽</a></li>
                <li><a href="#components">🔧 系統組件</a></li>
                <li><a href="#dataflow">📊 數據流程</a></li>
                <li><a href="#tech-stack">💻 技術架構</a></li>
                <li><a href="#modules">🧩 模組設計</a></li>
                <li><a href="#api">🔗 API 設計</a></li>
                <li><a href="#database">🗄️ 資料庫架構</a></li>
                <li><a href="#security">🔒 安全性設計</a></li>
                <li><a href="#scalability">📈 擴展性設計</a></li>
                <li><a href="#demo">🎬 系統演示</a></li>
            </ul>
        </nav>

        <!-- Architecture Overview -->
        <div class="card" id="overview">
            <h2><span class="icon">🎯</span>架構概覽</h2>
            
            <h3>核心設計理念</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>🔄 分離關注點</h4>
                    <p>前端負責數據收集，後端負責數據處理和存儲</p>
                </div>
                <div class="feature-item">
                    <h4>⚡ 即時通訊</h4>
                    <p>使用 WebSocket 實現低延遲的雙向通訊</p>
                </div>
                <div class="feature-item">
                    <h4>🧩 模組化設計</h4>
                    <p>各組件獨立運行，易於維護和擴展</p>
                </div>
                <div class="feature-item">
                    <h4>🛡️ 容錯處理</h4>
                    <p>多層次的錯誤處理和自動恢復機制</p>
                </div>
            </div>

            <h3>整體架構圖</h3>
            <div class="mermaid">
graph TD
    A[PG Slot Game Website] --> B[Chrome Extension]
    B --> C[Content Script]
    B --> D[Background Script]
    B --> E[Popup Interface]
    C --> F[Injected Script]
    
    G[HTTP API]
    H[WebSocket]
    
    I[Python Proxy Server]
    I --> J[Game Data Processor]
    I --> K[Database Manager]
    I --> L[WebSocket Handler]
    I --> M[HTTP API Handler]
    
    N[PostgreSQL Database]
    O[Game Data Tables]
    P[Provider Registry]
    Q[Game Registry]
    
    B --> G
    B --> H
    G --> I
    H --> I
    K --> N
    N --> O
    N --> P
    N --> Q
            </div>

            <h3>系統實際截圖</h3>
            <div class="media-container">
                <img src="gameDump_extension_screenShot.png" alt="Game Dump Extension 截圖" style="width: 70%; max-width: 70%;">
                <p class="media-caption">Game Dump Extension Chrome 擴展介面</p>
            </div>
        </div>

        <!-- System Components -->
        <div class="card" id="components">
            <h2><span class="icon">🔧</span>系統組件</h2>
            
            <h3>1. 前端組件 (Chrome Extension)</h3>
            <div class="arch-grid">
                <div class="arch-component">
                    <h4>Background Script</h4>
                    <ul>
                        <li>管理 WebSocket 連接生命週期</li>
                        <li>處理與後端伺服器的通訊</li>
                        <li>協調不同腳本間的消息傳遞</li>
                        <li>維護擴展的全域狀態</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>Content Script</h4>
                    <ul>
                        <li>在網頁環境中運行執行</li>
                        <li>注入自訂腳本到遊戲頁面</li>
                        <li>處理鍵盤事件模擬</li>
                        <li>與 injected script 進行訊息傳遞</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>Injected Script</h4>
                    <ul>
                        <li>在網頁 JavaScript 環境執行</li>
                        <li>攔截遊戲 API 請求和響應</li>
                        <li>提取遊戲狀態和結果數據</li>
                        <li>與 content script 通訊傳遞數據</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>Popup Interface</h4>
                    <ul>
                        <li>提供使用者操作介面</li>
                        <li>顯示連接狀態和收集進度</li>
                        <li>配置收集參數</li>
                        <li>控制數據收集的開始和停止</li>
                    </ul>
                </div>
            </div>

            <h3>檔案結構圖</h3>
            <div class="code-container">
                <div class="code-header">
                    <span>📁</span> Chrome Extension 檔案結構
                </div>
                <pre><code class="language-text">dumpExtension/
├── manifest.json          # 擴展配置清單
├── config.js              # 統一配置管理
├── background.js           # 背景服務腳本
├── popup.js               # 彈出介面腳本
├── popup.html             # 彈出介面 HTML
├── content.js             # 內容腳本
├── injected.js            # 注入腳本
├── utils/                 # 工具模組
│   ├── websocket-manager.js
│   ├── data-sync-manager.js
│   └── utils.js
└── icons/                 # 圖示資源</code></pre>
            </div>

            <h3>2. 後端組件 (Python Proxy Server)</h3>
            <div class="arch-grid">
                <div class="arch-component">
                    <h4>GameDumpServer</h4>
                    <ul>
                        <li>主伺服器類，整合所有組件</li>
                        <li>管理 HTTP 和 WebSocket 服務</li>
                        <li>協調各個處理器的工作</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>GameDumpState</h4>
                    <ul>
                        <li>遊戲數據轉儲狀態管理</li>
                        <li>維護收集進度和配置</li>
                        <li>提供狀態序列化功能</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>DatabaseManager</h4>
                    <ul>
                        <li>資料庫連接管理</li>
                        <li>提供安全的資料庫操作</li>
                        <li>處理連接池和事務</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>GameDataProcessor</h4>
                    <ul>
                        <li>遊戲數據處理和驗證</li>
                        <li>數據格式轉換</li>
                        <li>業務邏輯處理</li>
                    </ul>
                </div>
            </div>

            <h3>後端檔案結構</h3>
            <div class="code-container">
                <div class="code-header">
                    <span>🐍</span> Python 後端檔案結構
                </div>
                <pre><code class="language-text">pythonProxyServer/
├── proxy_refactored.py         # 主伺服器程式
├── pg_oper_module.py          # 資料庫操作模組
├── start_server.py            # 啟動腳本
├── config.json                # 配置檔案
├── test_refactored.py         # 測試腳本
└── 各種分析工具腳本...</code></pre>
            </div>
        </div>

        <!-- Data Flow -->
        <div class="card" id="dataflow">
            <h2><span class="icon">📊</span>數據流程</h2>
            
            <h3>1. 數據收集流程</h3>
            <div class="mermaid">
sequenceDiagram
    participant Game as PG Slot Game
    participant Inject as Injected Script
    participant Content as Content Script
    participant BG as Background Script
    participant Server as Python Server
    participant DB as PostgreSQL
    
    Game->>Inject: API Request Response
    Inject->>Inject: Data Parsing
    Inject->>Content: postMessage
    Content->>BG: runtime sendMessage
    BG->>Server: WebSocket Send
    Server->>Server: Data Processing
    Server->>DB: Store Data
    DB->>Server: Confirm Storage
    Server->>BG: Result
    BG->>Content: Status Update
    Content->>Inject: Continue
            </div>

            <h3>2. 配置同步流程</h3>
            <div class="mermaid">
sequenceDiagram
    participant Popup as Popup Interface
    participant BG as Background Script
    participant Server as Python Server
    participant DB as PostgreSQL
    
    Popup->>BG: Set Configuration
    BG->>Server: HTTP POST Config
    Server->>Server: Validate Config
    Server->>DB: Query Game Info
    DB->>Server: Game Information
    Server->>BG: Config Confirmation
    BG->>Popup: Status Update
            </div>

            <h3>3. 自動操作流程</h3>
            <div class="mermaid">
flowchart TD
    A[Start Collection] --> B{Check Game Status}
    B -->|Game Ready| C[Execute Betting Operation]
    B -->|Game Not Ready| D[Wait for Game Loading]
    C --> E[Intercept API Response]
    E --> F[Parse Game Results]
    F --> G[Send Data to Server]
    G --> H{Check Collection Count}
    H -->|Target Not Reached| I[Wait Interval Time]
    H -->|Target Reached| J[End Collection]
    I --> C
    D --> B
            </div>

            <h3>數據處理步驟</h3>
            <div class="process-flow">
                <div class="process-step">
                    <div class="step-number">1</div>
                    <h4>API 攔截</h4>
                    <p>捕獲遊戲 API 請求和響應</p>
                </div>
                <div class="process-step">
                    <div class="step-number">2</div>
                    <h4>數據解析</h4>
                    <p>提取關鍵遊戲信息</p>
                </div>
                <div class="process-step">
                    <div class="step-number">3</div>
                    <h4>格式轉換</h4>
                    <p>轉換為標準數據格式</p>
                </div>
                <div class="process-step">
                    <div class="step-number">4</div>
                    <h4>數據驗證</h4>
                    <p>檢查數據完整性和有效性</p>
                </div>
                <div class="process-step">
                    <div class="step-number">5</div>
                    <h4>存儲處理</h4>
                    <p>存入 PostgreSQL 資料庫</p>
                </div>
            </div>
        </div>

        <!-- Tech Stack -->
        <div class="card" id="tech-stack">
            <h2><span class="icon">💻</span>技術架構</h2>
            
            <h3>前端技術棧</h3>
            <div class="tech-stack">
                <div class="tech-item">
                    <h5>Chrome Extension API</h5>
                    <div class="version">Manifest V3</div>
                    <div class="purpose">擴展框架</div>
                </div>
                <div class="tech-item">
                    <h5>JavaScript</h5>
                    <div class="version">ES6+</div>
                    <div class="purpose">主要程式語言</div>
                </div>
                <div class="tech-item">
                    <h5>WebSocket API</h5>
                    <div class="version">-</div>
                    <div class="purpose">即時通訊</div>
                </div>
                <div class="tech-item">
                    <h5>Fetch API</h5>
                    <div class="version">-</div>
                    <div class="purpose">HTTP 請求</div>
                </div>
            </div>

            <h3>後端技術棧</h3>
            <div class="tech-stack">
                <div class="tech-item">
                    <h5>Python</h5>
                    <div class="version">3.8+</div>
                    <div class="purpose">主要程式語言</div>
                </div>
                <div class="tech-item">
                    <h5>Flask</h5>
                    <div class="version">2.0+</div>
                    <div class="purpose">HTTP API 框架</div>
                </div>
                <div class="tech-item">
                    <h5>websockets</h5>
                    <div class="version">10.0+</div>
                    <div class="purpose">WebSocket 伺服器</div>
                </div>
                <div class="tech-item">
                    <h5>psycopg2</h5>
                    <div class="version">2.9+</div>
                    <div class="purpose">PostgreSQL 驅動</div>
                </div>
            </div>

            <h3>資料庫技術</h3>
            <div class="tech-stack">
                <div class="tech-item">
                    <h5>PostgreSQL</h5>
                    <div class="version">12.0+</div>
                    <div class="purpose">主要資料庫</div>
                </div>
                <div class="tech-item">
                    <h5>JSON</h5>
                    <div class="version">-</div>
                    <div class="purpose">半結構化數據</div>
                </div>
                <div class="tech-item">
                    <h5>SQL</h5>
                    <div class="version">-</div>
                    <div class="purpose">數據查詢語言</div>
                </div>
            </div>
        </div>

        <!-- Modules -->
        <div class="card" id="modules">
            <h2><span class="icon">🧩</span>模組設計</h2>
            
            <h3>前端模組架構</h3>
            <div class="code-container">
                <div class="code-header">
                    <span>⚙️</span> 配置管理模組 (config.js)
                </div>
                <pre><code class="language-javascript">const CONFIG = {
    SERVER: {
        HTTP_HOST: 'http://localhost:8080',
        WS_HOST: 'ws://localhost:8081'
    },
    DEFAULTS: {
        TOTAL_DUMP_COUNT: 5,
        TIME_STEP: 2,
        SPIN_INTERVAL: 3500
    },
    MESSAGE_TYPES: {
        REFRESH: 'refresh',
        TO_BACKGROUND: 'toBK',
        BUTTON_CLICKED: 'button_clicked'
    }
};</code></pre>
            </div>

            <div class="code-container">
                <div class="code-header">
                    <span>🔌</span> WebSocket 管理器
                </div>
                <pre><code class="language-javascript">class WebSocketManager {
    constructor(url, options = {}) {
        this.url = url;
        this.options = {
            maxReconnectAttempts: 10,
            reconnectInterval: 5000,
            heartbeatInterval: 2000,
            ...options
        };
        this.socket = null;
        this.reconnectAttempts = 0;
    }
    
    connect() {
        return new Promise((resolve, reject) => {
            this.socket = new WebSocket(this.url);
            // 設定事件處理器
            this.socket.onopen = this.handleOpen.bind(this);
            this.socket.onmessage = this.handleMessage.bind(this);
            this.socket.onclose = this.handleClose.bind(this);
            this.socket.onerror = this.handleError.bind(this);
        });
    }
}</code></pre>
            </div>

            <h3>後端模組架構</h3>
            <div class="code-container">
                <div class="code-header">
                    <span>🎮</span> 遊戲數據處理器
                </div>
                <pre><code class="language-python">class GameDataProcessor:
    """遊戲數據處理器"""
    def __init__(self, db_manager: DatabaseManager, state: GameDumpState):
        self.db = db_manager
        self.state = state
    
    def process_spin_result(self, spin_data: Dict) -> Dict:
        """處理旋轉結果數據"""
        # 數據驗證、轉換、存儲邏輯
        pass
    
    def get_provider_info(self, origin: str) -> Dict:
        """獲取供應商信息"""
        # 查詢供應商註冊表
        pass</code></pre>
            </div>

            <div class="code-container">
                <div class="code-header">
                    <span>🗄️</span> 資料庫管理器
                </div>
                <pre><code class="language-python">class DatabaseManager:
    """資料庫管理器"""
    def __init__(self, config: DatabaseConfig):
        self.config = config
        self.connection = None
        self.pg_oper = None
        self.connect()
    
    def connect(self):
        """建立資料庫連接"""
        self.connection = psycopg2.connect(
            database=self.config.db_name,
            user=self.config.db_user,
            password=self.config.db_password,
            host=self.config.db_host,
            port=self.config.db_port
        )
        self.pg_oper = pg_oper(self.connection)</code></pre>
            </div>
        </div>

        <!-- API Design -->
        <div class="card" id="api">
            <h2><span class="icon">🔗</span>API 設計</h2>
            
            <h3>HTTP API 端點</h3>
            
            <div class="api-endpoint">
                <span class="api-method get">GET</span>
                <strong>/status</strong> - 伺服器狀態查詢
                <div class="code-container" style="margin-top: 15px;">
                    <pre><code class="language-json">{
    "status": "running",
    "timestamp": "2024-01-01T12:00:00Z",
    "version": "1.0.6"
}</code></pre>
                </div>
            </div>

            <div class="api-endpoint">
                <span class="api-method post">POST</span>
                <strong>/sendCurrentUrl</strong> - 接收當前遊戲 URL
                <div class="code-container" style="margin-top: 15px;">
                    <div class="code-header">Request</div>
                    <pre><code class="language-json">{
    "url": "https://m.pgsoft-games.com/game",
    "origin": "m.pgsoft-games.com"
}</code></pre>
                </div>
                <div class="code-container">
                    <div class="code-header">Response</div>
                    <pre><code class="language-json">{
    "success": true,
    "message": "URL processed successfully",
    "data": {
        "providerInfo": [...],
        "gameInfo": {...}
    }
}</code></pre>
                </div>
            </div>

            <div class="api-endpoint">
                <span class="api-method post">POST</span>
                <strong>/sentCurrentSettingToServer</strong> - 接收遊戲設定
                <div class="code-container" style="margin-top: 15px;">
                    <div class="code-header">Request</div>
                    <pre><code class="language-json">{
    "dumpSeed": "test_seed_001",
    "maxDumpCount": 100,
    "gameKey": "wild_bounty"
}</code></pre>
                </div>
            </div>

            <div class="api-endpoint">
                <span class="api-method post">POST</span>
                <strong>/sendSpinRes</strong> - 接收旋轉結果數據
                <div class="code-container" style="margin-top: 15px;">
                    <div class="code-header">Request</div>
                    <pre><code class="language-json">{
    "currentSpinCount": 1,
    "maxSpinCount": 100,
    "spinRes": {
        "dt": {
            "si": {
                "tw": 1000,
                "tb": 400,
                "rl": [1,2,3,4,5]
            }
        }
    }
}</code></pre>
                </div>
            </div>

            <h3>WebSocket API 設計</h3>
            <div class="api-endpoint">
                <span class="api-method ws">WS</span>
                <strong>ws://localhost:8081</strong> - WebSocket 連接端點
                <div class="code-container" style="margin-top: 15px;">
                    <div class="code-header">訊息格式</div>
                    <pre><code class="language-json">{
    "type": "message_type",
    "timestamp": "2024-01-01T12:00:00Z",
    "data": {
        "key": "value"
    }
}</code></pre>
                </div>
            </div>

            <div class="alert alert-info">
                <strong>支援的訊息類型：</strong>
                <ul style="margin-top: 10px;">
                    <li><code>listen</code> - 開始監聽</li>
                    <li><code>sentReqSet</code> - 發送設定</li>
                    <li><code>sentGameURL</code> - 發送遊戲 URL</li>
                    <li><code>spinRes</code> - 發送旋轉結果</li>
                    <li><code>gameInfo</code> - 發送遊戲信息</li>
                </ul>
            </div>
        </div>

        <!-- Database Architecture -->
        <div class="card" id="database">
            <h2><span class="icon">🗄️</span>資料庫架構</h2>
            
            <h3>PostgreSQL 資料庫概覽</h3>
            <div class="media-container">
                <img src="postgreSQL_DB.png" alt="PostgreSQL 資料庫結構" style="width: 50%; max-width: 50%;">
                <p class="media-caption">PostgreSQL 資料庫整體架構</p>
            </div>
            
            <h3>主要資料表</h3>
            <div class="media-container">
                <img src="game_reg_table.png" alt="遊戲註冊表">
                <p class="media-caption">遊戲註冊表 (game_reg) 結構</p>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>資料表</th>
                            <th>用途</th>
                            <th>主要欄位</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>provider_reg</strong></td>
                            <td>供應商註冊表</td>
                            <td>id, provider_name, host, config</td>
                        </tr>
                        <tr>
                            <td><strong>game_reg</strong></td>
                            <td>遊戲註冊表</td>
                            <td>id, game_name, game_key, table_name</td>
                        </tr>
                        <tr>
                            <td><strong>tb_pg_*_v1_001</strong></td>
                            <td>遊戲數據表（動態創建）</td>
                            <td>index, tw, tb, rl, gm, raw_data</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>資料關聯圖</h3>
            <div class="mermaid">
graph TD
    A[PROVIDER_REG<br/>Provider Registry<br/>id, provider_name, host]
    B[GAME_REG<br/>Game Registry<br/>id, game_name, game_key]
    C[GAME_DATA_TABLES<br/>Game Data Tables<br/>index, tw, tb, rl, gm]
    
    A -->|has| B
    B -->|generates| C
            </div>

            <h3>遊戲數據表結構</h3>
            <div class="media-container">
                <img src="gameRecord_wildBounty_table.png" alt="Wild Bounty 遊戲數據表">
                <p class="media-caption">Wild Bounty 遊戲數據表實際結構</p>
            </div>
            
            <div class="code-container">
                <div class="code-header">
                    <span>📊</span> SQL 表格定義
                </div>
                <pre><code class="language-sql">-- 範例：tb_pg_wild_bounty_v1_001
CREATE TABLE tb_pg_wild_bounty_v1_001 (
    index SERIAL PRIMARY KEY,
    sn INTEGER NOT NULL,
    dump_seed VARCHAR(255),
    game_name VARCHAR(255),
    bet_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tw INTEGER,              -- Total Win
    tb INTEGER,              -- Total Bet
    rl JSONB,               -- Reel Layout
    gm INTEGER,             -- Game Mode
    ml INTEGER,             -- Max Lines
    mrl JSONB,              -- Max Reel Layout
    orl JSONB,              -- Original Reel Layout
    is_free_game BOOLEAN DEFAULT FALSE,
    multiplier INTEGER DEFAULT 1,
    raw_data JSONB          -- 完整的原始數據
);

-- 建立索引以優化查詢效能
CREATE INDEX idx_dump_seed ON tb_pg_wild_bounty_v1_001(dump_seed);
CREATE INDEX idx_bet_time ON tb_pg_wild_bounty_v1_001(bet_time);
CREATE INDEX idx_game_mode ON tb_pg_wild_bounty_v1_001(gm);</code></pre>
            </div>
        </div>

        <!-- Security -->
        <div class="card" id="security">
            <h2><span class="icon">🔒</span>安全性設計</h2>
            
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>🛡️ 輸入驗證</h4>
                    <p>SQL 注入防護、XSS 防護、數據類型驗證</p>
                </div>
                <div class="feature-item">
                    <h4>🔐 連接安全</h4>
                    <p>CORS 配置、WebSocket 驗證、SSL/TLS 支援</p>
                </div>
                <div class="feature-item">
                    <h4>🗃️ 資料庫安全</h4>
                    <p>最小權限原則、連接加密、備份策略</p>
                </div>
                <div class="feature-item">
                    <h4>📝 日誌監控</h4>
                    <p>操作日誌、錯誤追蹤、異常警報</p>
                </div>
            </div>

            <h3>輸入驗證範例</h3>
            <div class="code-container">
                <div class="code-header">
                    <span>🔍</span> Python 輸入驗證
                </div>
                <pre><code class="language-python">def validate_input(data):
    """輸入驗證範例"""
    if not isinstance(data, dict):
        raise ValueError("Invalid data format")
    
    # 檢查必要欄位
    required_fields = ['dump_seed', 'spin_count']
    for field in required_fields:
        if field not in data:
            raise ValueError(f"Missing required field: {field}")
    
    # 數據類型驗證
    if not isinstance(data['spin_count'], int) or data['spin_count'] <= 0:
        raise ValueError("Invalid spin count")
    
    return True</code></pre>
            </div>

            <div class="alert alert-warning">
                <strong>⚠️ 安全注意事項：</strong>
                <ul style="margin-top: 10px;">
                    <li>定期更新依賴套件版本</li>
                    <li>使用強密碼和加密連接</li>
                    <li>限制 API 訪問頻率</li>
                    <li>監控異常訪問模式</li>
                </ul>
            </div>
        </div>

        <!-- Scalability -->
        <div class="card" id="scalability">
            <h2><span class="icon">📈</span>擴展性設計</h2>
            
            <h3>水平擴展架構</h3>
            <div class="mermaid">
graph TD
    LB[Load Balancer]
    
    S1[Server Instance 1]
    S2[Server Instance 2]  
    S3[Server Instance 3]
    
    DB1[Primary DB]
    DB2[Read Replica 1]
    DB3[Read Replica 2]
    
    LB --> S1
    LB --> S2
    LB --> S3
    
    S1 --> DB1
    S2 --> DB2
    S3 --> DB3
            </div>

            <h3>效能優化策略</h3>
            <div class="arch-grid">
                <div class="arch-component">
                    <h4>連接池管理</h4>
                    <ul>
                        <li>資料庫連接池</li>
                        <li>WebSocket 連接管理</li>
                        <li>HTTP 請求池化</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>快取機制</h4>
                    <ul>
                        <li>記憶體快取常用數據</li>
                        <li>查詢結果快取</li>
                        <li>配置資訊快取</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>非同步處理</h4>
                    <ul>
                        <li>非阻塞 I/O 操作</li>
                        <li>多執行緒處理</li>
                        <li>事件驅動架構</li>
                    </ul>
                </div>
                <div class="arch-component">
                    <h4>負載分散</h4>
                    <ul>
                        <li>微服務架構</li>
                        <li>服務發現機制</li>
                        <li>自動擴縮容</li>
                    </ul>
                </div>
            </div>

            <h3>擴展配置</h3>
            <div class="code-container">
                <div class="code-header">
                    <span>⚙️</span> 可擴展性配置
                </div>
                <pre><code class="language-python">class ScalabilityConfig:
    def __init__(self):
        self.max_connections = int(os.getenv('MAX_CONNECTIONS', '100'))
        self.worker_processes = int(os.getenv('WORKER_PROCESSES', '4'))
        self.db_pool_size = int(os.getenv('DB_POOL_SIZE', '20'))
        self.cache_size = int(os.getenv('CACHE_SIZE', '1000'))
        
        # 負載均衡配置
        self.enable_load_balancing = os.getenv('ENABLE_LB', 'false').lower() == 'true'
        self.server_instances = os.getenv('SERVER_INSTANCES', '1')
        
        # 監控配置
        self.enable_metrics = os.getenv('ENABLE_METRICS', 'true').lower() == 'true'
        self.metrics_port = int(os.getenv('METRICS_PORT', '9090'))</code></pre>
            </div>

            <div class="alert alert-success">
                <strong>✨ 未來擴展方向：</strong>
                <ul style="margin-top: 10px;">
                    <li>支援更多遊戲供應商和類型</li>
                    <li>添加機器學習數據分析功能</li>
                    <li>實現雲端部署和自動擴縮容</li>
                    <li>開發行動端管理應用</li>
                </ul>
            </div>
        </div>

        <!-- 系統演示影片 -->
        <div class="card" id="demo">
            <h2><span class="icon">🎬</span>系統演示影片</h2>
            <div class="media-container">
                <video controls>
                    <source src="gameDump.mp4" type="video/quicktime">
                    <source src="gameDump.mp4" type="video/mp4">
                    您的瀏覽器不支援影片播放。
                </video>
                <p class="media-caption">Game Dump 工具完整操作演示</p>
            </div>
            
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>🚀 快速部署</h4>
                    <p>一鍵安裝 Chrome 擴展，簡單配置即可開始使用</p>
                </div>
                <div class="feature-item">
                    <h4>📊 即時監控</h4>
                    <p>實時顯示數據收集進度和系統狀態</p>
                </div>
                <div class="feature-item">
                    <h4>🔧 彈性配置</h4>
                    <p>支援多種遊戲和客製化參數設定</p>
                </div>
                <div class="feature-item">
                    <h4>📈 數據分析</h4>
                    <p>提供豐富的數據分析和視覺化功能</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="header" style="margin-top: 40px; text-align: center;">
            <p style="color: #7f8c8d; font-size: 0.9em;">
                © 2025 Game Dump Tool | 版本 1.0.6<br>
                最後更新: 2025年9月29日<br>
                <a href="https://github.com/alphaelf0080/gameDumpTool" style="color: #3498db;">GitHub Repository</a>
            </p>
        </div>
    </div>

    <script>
        // 初始化 Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Arial, sans-serif',
            flowchart: {
                useMaxWidth: true
            },
            sequence: {
                useMaxWidth: true,
                showSequenceNumbers: false
            },
            er: {
                useMaxWidth: true
            }
        });

        // 平滑滾動到錨點
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // 初始化和載入處理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing Mermaid...');
            
            // 延遲初始化以確保所有資源載入完成
            setTimeout(() => {
                try {
                    // 手動渲染每個圖表
                    const mermaidElements = document.querySelectorAll('.mermaid');
                    console.log(`Found ${mermaidElements.length} mermaid elements`);
                    
                    mermaidElements.forEach((element, index) => {
                        console.log(`Processing mermaid element ${index + 1}`);
                        const content = element.textContent.trim();
                        
                        if (content) {
                            // 清空元素並顯示載入狀態
                            element.innerHTML = '<div class="mermaid-loading">🔄 載入圖表中...</div>';
                            
                            // 嘗試渲染圖表
                            try {
                                mermaid.render(`mermaid-${index}`, content).then(result => {
                                    element.innerHTML = result.svg;
                                    console.log(`Mermaid chart ${index + 1} rendered successfully`);
                                }).catch(error => {
                                    console.error(`Failed to render mermaid chart ${index + 1}:`, error);
                                    element.innerHTML = `
                                        <div style="text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px;">
                                            <p>⚠️ 圖表載入失敗</p>
                                            <p style="font-size: 0.8em; color: #666;">錯誤: ${error.message || 'Unknown error'}</p>
                                            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                                🔄 重新載入頁面
                                            </button>
                                        </div>
                                    `;
                                });
                            } catch (error) {
                                console.error(`Error rendering mermaid chart ${index + 1}:`, error);
                                element.innerHTML = `
                                    <div style="text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px;">
                                        <p>⚠️ 圖表載入失敗</p>
                                        <p style="font-size: 0.8em; color: #666;">語法錯誤或不支援的圖表類型</p>
                                    </div>
                                `;
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error initializing Mermaid:', error);
                }
            }, 1000);
        });

        // 添加程式碼複製功能
        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('pre code');
            codeBlocks.forEach((codeBlock, index) => {
                const button = document.createElement('button');
                button.className = 'copy-button';
                button.textContent = '📋 複製';
                button.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: #2c3e50;
                    color: white;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    z-index: 10;
                `;
                
                const container = codeBlock.closest('.code-container');
                if (container) {
                    container.style.position = 'relative';
                    container.appendChild(button);
                    
                    button.addEventListener('click', function() {
                        const textArea = document.createElement('textarea');
                        textArea.value = codeBlock.textContent;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        button.textContent = '✅ 已複製';
                        setTimeout(() => {
                            button.textContent = '📋 複製';
                        }, 2000);
                    });
                }
            });
        });

        // 添加返回頂部按鈕
        const backToTopButton = document.createElement('button');
        backToTopButton.innerHTML = '⬆️';
        backToTopButton.style.cssText = `
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        `;
        document.body.appendChild(backToTopButton);

        // 顯示/隱藏返回頂部按鈕
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                backToTopButton.style.opacity = '1';
            } else {
                backToTopButton.style.opacity = '0';
            }
        });

        // 返回頂部功能
        backToTopButton.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>