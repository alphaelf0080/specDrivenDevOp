# ğŸ”§ å•é¡Œä¿®å¾©èªªæ˜

## å•é¡Œè¨ºæ–·

### ç—‡ç‹€
- âœ… Console é¡¯ç¤ºæ­£å¸¸åŸ·è¡Œï¼ˆæ–°å¢/åˆªé™¤/ä¿å­˜éƒ½æœ‰æ—¥èªŒï¼‰
- âœ… å¾Œç«¯æ”¶åˆ°è«‹æ±‚ä¸¦æˆåŠŸä¿å­˜
- âŒ **ç•«é¢æ²’æœ‰æ›´æ–°**ï¼ˆç¯€é»æ²’æœ‰é¡¯ç¤º/æ¶ˆå¤±ï¼‰

### æ ¹æœ¬åŸå› 

åœ¨ `MindMapCanvas.tsx` ä¸­ä½¿ç”¨äº† `initialized` æ¨™è¨˜ï¼š

```tsx
const [initialized, setInitialized] = useState(false);

useEffect(() => {
  if (!initialized && initialNodes.length > 0) {
    setNodes(initialNodes);
    setEdges(initialEdges);
    setInitialized(true);  // âŒ ä¹‹å¾Œå°±ä¸å†æ›´æ–°äº†
  }
}, [initialNodes, initialEdges, initialized, setNodes, setEdges]);
```

**å•é¡Œï¼š**
- `initialized` è¨­ç‚º `true` å¾Œï¼Œå³ä½¿ `initialNodes` è®ŠåŒ–ä¹Ÿä¸æœƒæ›´æ–°
- é€™å€‹æ¨™è¨˜åŸæœ¬æ˜¯ç‚ºäº†é˜²æ­¢æ‹–æ›³å›å½ˆ
- ä½†å®ƒåŒæ™‚ä¹Ÿé˜»æ­¢äº†æ–°å¢/åˆªé™¤ç¯€é»å¾Œçš„æ›´æ–°

## è§£æ±ºæ–¹æ¡ˆ

### ä¿®æ”¹ `MindMapCanvas.tsx`

ç§»é™¤ `initialized` æ¨™è¨˜ï¼Œæ”¹ç”¨ **ç¯€é»æ•¸é‡è¿½è¹¤**ï¼š

```tsx
// ä½¿ç”¨ ref è¿½è¹¤å‰ä¸€æ¬¡çš„ç¯€é»æ•¸é‡
const prevNodeCountRef = React.useRef(0);

useEffect(() => {
  const currentNodeCount = initialNodes.length;
  
  // åªåœ¨ç¯€é»æ•¸é‡æ”¹è®Šæ™‚æ›´æ–°ï¼ˆæ–°å¢/åˆªé™¤ï¼‰
  if (prevNodeCountRef.current !== currentNodeCount) {
    console.log(`ğŸ”„ Node count changed: ${prevNodeCountRef.current} â†’ ${currentNodeCount}`);
    setNodes(initialNodes);
    setEdges(initialEdges);
    prevNodeCountRef.current = currentNodeCount;
  }
}, [initialNodes, initialEdges, setNodes, setEdges]);
```

### ç‚ºä»€éº¼é€™æ¨£å¯è¡Œï¼Ÿ

1. **æ–°å¢ç¯€é»**ï¼š`initialNodes.length` å¢åŠ  â†’ è§¸ç™¼æ›´æ–° âœ…
2. **åˆªé™¤ç¯€é»**ï¼š`initialNodes.length` æ¸›å°‘ â†’ è§¸ç™¼æ›´æ–° âœ…
3. **æ‹–æ›³ç¯€é»**ï¼š`initialNodes.length` ä¸è®Š â†’ **ä¸è§¸ç™¼æ›´æ–°** âœ…ï¼ˆé¿å…å›å½ˆï¼‰
4. **æ¨£å¼è®Šæ›´**ï¼š`initialNodes.length` ä¸è®Š â†’ ä¸è§¸ç™¼æ›´æ–°ï¼ˆä½†æ¨£å¼ç›´æ¥åœ¨æœ¬åœ° state æ›´æ–°ï¼‰âœ…

## æ¸¬è©¦æ­¥é©Ÿ

### 1. é‡æ–°æ•´ç†ç€è¦½å™¨
æŒ‰ `Cmd+Shift+R`ï¼ˆMacï¼‰æˆ– `Ctrl+Shift+R`ï¼ˆWindows/Linuxï¼‰

### 2. é–‹å•Ÿ Consoleï¼ˆF12ï¼‰

### 3. æ¸¬è©¦æ–°å¢ç¯€é»
1. å³éµé»æ“Šä»»ä¸€ç¯€é»
2. é¸æ“‡ã€Œâ• æ–°å¢å­ç¯€é»ã€
3. **é æœŸçµæœï¼š**
   - Console é¡¯ç¤ºï¼š
     ```
     ğŸ†• Adding new node to parent: xxx
     ğŸ”„ Node count changed: 27 â†’ 28
     âœ… Node added, saving layout...
     âœ… Layout saved to server
     ```
   - **ç•«é¢ä¸Šå‡ºç¾æ–°ç¯€é»** âœ…

### 4. æ¸¬è©¦åˆªé™¤ç¯€é»
1. å³éµé»æ“Šå‰›æ‰æ–°å¢çš„ç¯€é»
2. é¸æ“‡ã€ŒğŸ—‘ï¸ åˆªé™¤ç¯€é»ã€
3. **é æœŸçµæœï¼š**
   - Console é¡¯ç¤ºï¼š
     ```
     ğŸ—‘ï¸ Deleting node: node-xxx
     ğŸ”„ Node count changed: 28 â†’ 27
     âœ… Node deleted, saving layout...
     âœ… Layout saved to server
     ```
   - **ç¯€é»å¾ç•«é¢ä¸Šæ¶ˆå¤±** âœ…

### 5. æ¸¬è©¦æ‹–æ›³ï¼ˆç¢ºä¿æ²’æœ‰å›å½ˆï¼‰
1. æ‹–æ›³ä»»ä¸€ç¯€é»
2. æ”¾é–‹
3. **é æœŸçµæœï¼š**
   - ç¯€é»åœç•™åœ¨æ–°ä½ç½®ï¼ˆ**ä¸å›å½ˆ**ï¼‰âœ…
   - Console é¡¯ç¤ºï¼š`âœ… Layout saved to server`
   - **æ²’æœ‰** `ğŸ”„ Node count changed` è¨Šæ¯ï¼ˆå› ç‚ºæ•¸é‡æ²’è®Šï¼‰

### 6. æ¸¬è©¦æ¨£å¼ç·¨è¼¯
1. å³éµé»æ“Šç¯€é»
2. é¸æ“‡ã€ŒğŸ¨ ç·¨è¼¯ç¯€é»æ¨£å¼ã€
3. èª¿æ•´é¡è‰²ä¸¦å„²å­˜
4. **é æœŸçµæœï¼š**
   - æ¨£å¼ç«‹å³å¥—ç”¨ âœ…
   - Console é¡¯ç¤ºï¼š`âœ… Layout saved to server`
   - é‡æ–°æ•´ç†å¾Œæ¨£å¼ä¿ç•™ âœ…

## é æœŸçš„ Console è¼¸å‡º

### å®Œæ•´çš„æ“ä½œæµç¨‹

```
ğŸ“ Loading saved layout from server: 27 nodes

[æ–°å¢ç¯€é»]
ğŸ†• Adding new node to parent: concept-sdd
ğŸ”„ Node count changed: 27 â†’ 28
âœ… Node added, saving layout...
âœ… Layout saved to server

[åˆªé™¤ç¯€é»]
ğŸ—‘ï¸ Deleting node: node-1696584321234
ğŸ”„ Node count changed: 28 â†’ 27
âœ… Node deleted, saving layout...
âœ… Layout saved to server

[æ‹–æ›³ç¯€é» - ç„¡ count changed]
âœ… Layout saved to server

[ç·¨è¼¯æ¨£å¼ - ç„¡ count changed]
âœ… Layout saved to server
```

## å¦‚æœé‚„æ˜¯ä¸è¡Œ...

### æª¢æŸ¥æ¸…å–®

1. âœ… ç¢ºèªå‰ç«¯å·²é‡æ–°è¼‰å…¥ï¼ˆç¡¬é‡æ–°æ•´ç†ï¼‰
2. âœ… ç¢ºèª Console æœ‰ `ğŸ”„ Node count changed` è¨Šæ¯
3. âœ… ç¢ºèªå¾Œç«¯æ­£åœ¨é‹è¡Œ
4. âœ… æ¸…é™¤ç€è¦½å™¨å¿«å–

### å®Œå…¨é‡å•Ÿ

```bash
# åœæ­¢æ‰€æœ‰æœå‹™ï¼ˆCtrl+Cï¼‰

# åˆªé™¤å¿«å–å’Œé‡æ–°å®‰è£
rm -rf node_modules package-lock.json
npm install

# é‡æ–°å•Ÿå‹•
npm run dev:server  # çµ‚ç«¯ 1
npm run dev:client  # çµ‚ç«¯ 2
```

### å¦‚æœæ–°ç¯€é»å‡ºç¾ä½†ä½ç½®ä¸å°

é€™æ˜¯æ­£å¸¸çš„ï¼æ–°ç¯€é»æœƒé€šé `dagre` è‡ªå‹•å¸ƒå±€ï¼Œå¯èƒ½å‡ºç¾åœ¨ç•«é¢å¤–ã€‚
- **è§£æ±ºæ–¹æ³•**ï¼šç¸®å°ç•«é¢æˆ–ä½¿ç”¨æ»‘é¼ ä¸­éµæ‹–æ›³å°‹æ‰¾
- æˆ–é»æ“Šå·¦ä¸‹è§’çš„ã€ŒFit Viewã€æŒ‰éˆ•

## æŠ€è¡“ç´°ç¯€

### ç‚ºä»€éº¼ä¸ç”¨ `initialNodes` çš„æ·±åº¦æ¯”è¼ƒï¼Ÿ

æ·±åº¦æ¯”è¼ƒæ¯æ¬¡æ¸²æŸ“éƒ½æœƒåŸ·è¡Œï¼Œæ•ˆèƒ½è¼ƒå·®ã€‚è€Œä¸”ï¼š
- æ‹–æ›³æ™‚ `initialNodes` æœƒè®ŠåŒ–ï¼ˆä½ç½®æ”¹è®Šï¼‰
- æ¨£å¼è®Šæ›´æ™‚ `initialNodes` ä¹Ÿæœƒè®ŠåŒ–
- é€™äº›æƒ…æ³ä¸‹æˆ‘å€‘**ä¸æƒ³**å¾ props é‡æ–°è¼‰å…¥

### ç‚ºä»€éº¼ç”¨ `useRef` è€Œä¸æ˜¯ `useState`ï¼Ÿ

- `useRef` ä¸æœƒè§¸ç™¼é‡æ–°æ¸²æŸ“
- åªéœ€è¦è¿½è¹¤æ•¸å€¼ï¼Œä¸éœ€è¦æ¸²æŸ“åˆ° UI
- æ•ˆèƒ½æ›´å¥½

### æ‹–æ›³ç‚ºä»€éº¼ä¸æœƒå›å½ˆï¼Ÿ

å› ç‚ºï¼š
1. æ‹–æ›³åªæ”¹è®Šä½ç½®ï¼Œä¸æ”¹è®Šæ•¸é‡
2. `prevNodeCountRef.current !== currentNodeCount` ç‚º `false`
3. ä¸åŸ·è¡Œ `setNodes(initialNodes)`
4. ä¿ç•™æœ¬åœ°æ‹–æ›³å¾Œçš„ä½ç½® âœ…

## ç›¸é—œä¿®æ”¹

### æª”æ¡ˆï¼š`MindMapCanvas.tsx`

**ä¿®æ”¹å‰ï¼š**
```tsx
const [initialized, setInitialized] = useState(false);

useEffect(() => {
  if (!initialized && initialNodes.length > 0) {
    setNodes(initialNodes);
    setEdges(initialEdges);
    setInitialized(true);
  }
}, [initialNodes, initialEdges, initialized, setNodes, setEdges]);
```

**ä¿®æ”¹å¾Œï¼š**
```tsx
const prevNodeCountRef = React.useRef(0);

useEffect(() => {
  const currentNodeCount = initialNodes.length;
  
  if (prevNodeCountRef.current !== currentNodeCount) {
    console.log(`ğŸ”„ Node count changed: ${prevNodeCountRef.current} â†’ ${currentNodeCount}`);
    setNodes(initialNodes);
    setEdges(initialEdges);
    prevNodeCountRef.current = currentNodeCount;
  }
}, [initialNodes, initialEdges, setNodes, setEdges]);
```

---

âœ… **ä¿®å¾©å®Œæˆï¼ç¾åœ¨æ–°å¢å’Œåˆªé™¤ç¯€é»æ‡‰è©²å¯ä»¥æ­£å¸¸é¡¯ç¤ºäº†ï¼**
