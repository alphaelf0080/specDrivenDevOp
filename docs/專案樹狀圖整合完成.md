# 專案樹狀圖整合完成

## 📋 功能概述

已成功將樹狀圖編輯器整合到專案主視窗的黃色編輯區域，並實現與資料庫的完整綁定。

## ✨ 功能特點

### 1. 樹狀圖顯示
- ✅ 專案主視窗黃色區域顯示樹狀圖編輯器
- ✅ 自動載入專案的樹狀圖資料
- ✅ 無樹狀圖時顯示建立提示

### 2. 資料綁定
- ✅ 樹狀圖資料儲存在 `projects` 表的 `tree_data` 欄位（JSONB）
- ✅ 樹狀圖配置儲存在 `tree_config` 欄位（JSONB）
- ✅ 版本追蹤：`tree_version`（每次更新自動+1）
- ✅ 時間戳記：`tree_updated_at`（記錄最後更新時間）

### 3. 自動儲存
- ✅ 節點編輯後自動儲存到資料庫
- ✅ 顯示儲存狀態指示器
- ✅ 錯誤處理與日誌記錄

## 🗄️ 資料庫結構

### Projects 表新增欄位

```sql
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_data JSONB;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_config JSONB;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_version INTEGER DEFAULT 1;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_updated_at TIMESTAMP WITH TIME ZONE;

-- GIN 索引用於高效查詢 JSONB 資料
CREATE INDEX IF NOT EXISTS idx_projects_tree_data ON projects USING GIN (tree_data);
CREATE INDEX IF NOT EXISTS idx_projects_tree_config ON projects USING GIN (tree_config);
```

### 資料結構範例

```typescript
interface Project {
  id: number;
  name: string;
  // ... 其他欄位
  tree_data?: TreeNode | null;          // 樹狀圖結構
  tree_config?: Record<string, unknown> | null;  // 樹狀圖配置
  tree_version?: number;                // 版本號
  tree_updated_at?: string;             // 最後更新時間
}

interface TreeNode {
  id: string;
  label: string;
  children?: TreeNode[];
  // ... 其他節點屬性
}
```

## 🔌 API 端點

### 更新樹狀圖資料
**PUT** `/api/projects/:id/tree`

#### 請求範例
```json
{
  "tree_data": {
    "id": "root",
    "label": "專案根節點",
    "children": [...]
  },
  "tree_config": {
    "direction": "LR",
    "nodeWidth": 200
  }
}
```

#### 回應範例
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "範例專案",
    "tree_data": {...},
    "tree_config": {...},
    "tree_version": 3,
    "tree_updated_at": "2024-01-15T10:30:00Z"
  },
  "message": "樹狀圖已更新"
}
```

## 📁 修改的檔案

### 1. 資料庫配置
- `server/config/table.config.ts`
  - 新增 4 個樹狀圖相關欄位
  - 新增 2 個 GIN 索引

### 2. 後端 API
- `server/routes/projects.ts`
  - 新增 `PUT /api/projects/:id/tree` 端點
  - 實現樹狀圖資料更新邏輯
  - 自動版本號遞增

### 3. 前端組件
- `client/components/Project/ProjectMainWindow.tsx`
  - 新增 `treeData` 狀態管理
  - 實現 `handleTreeChange` 自動儲存
  - 整合 `TreeDiagram` 組件
  - 新增載入/儲存狀態指示

### 4. 樣式檔案
- `client/components/Project/ProjectMainWindow.css`
  - 新增 `.tree-diagram-container` 樣式
  - 新增 `.saving-indicator` 樣式
  - 新增 `.no-tree-placeholder` 樣式

## 🚀 使用方式

### 開啟專案樹狀圖
1. 從首頁點擊專案卡片
2. 專案主視窗自動開啟
3. 黃色編輯區域顯示樹狀圖編輯器

### 建立新樹狀圖
1. 若專案沒有樹狀圖，會顯示「建立新樹狀圖」按鈕
2. 點擊按鈕建立初始樹狀圖
3. 開始編輯節點

### 編輯樹狀圖
1. 點擊節點進行編輯
2. 新增子節點
3. 刪除節點
4. 所有變更自動儲存

### 查看儲存狀態
- 編輯時右上角顯示「⏳ 儲存中...」
- 儲存完成後自動隱藏

## 🔧 技術實現

### 狀態管理
```typescript
const [treeData, setTreeData] = useState<TreeNode | null>(null);
const [saving, setSaving] = useState(false);
```

### 載入樹狀圖
```typescript
const loadProject = async () => {
  const result = await fetch(`/api/projects/${projectId}`);
  const data = result.json();
  if (data.tree_data) {
    setTreeData(data.tree_data);
  }
};
```

### 自動儲存
```typescript
const handleTreeChange = async (nodeId: string, updates: Partial<TreeNode>) => {
  // 1. 更新本地狀態
  const updatedTree = updateNodeRecursive(treeData);
  setTreeData(updatedTree);
  
  // 2. 儲存到資料庫
  await fetch(`/api/projects/${projectId}/tree`, {
    method: 'PUT',
    body: JSON.stringify({ tree_data: updatedTree })
  });
};
```

## 📊 效能優化

### 1. JSONB 索引
- 使用 GIN 索引加速 JSONB 查詢
- 支援樹狀圖資料的高效搜尋

### 2. 版本控制
- `tree_version` 欄位追蹤變更
- 可用於實現樂觀鎖定
- 支援版本比對和衝突偵測

### 3. 時間戳記
- `tree_updated_at` 記錄最後修改時間
- 支援排序和篩選
- 可用於顯示「最近編輯」資訊

## 🎯 未來擴展

### 可能的增強功能
1. **版本歷史**
   - 記錄每個版本的樹狀圖快照
   - 支援版本回溯
   - 比較不同版本的差異

2. **協作編輯**
   - WebSocket 即時同步
   - 多人同時編輯
   - 衝突解決機制

3. **匯入/匯出**
   - 匯出為 JSON/圖片
   - 從其他專案匯入樹狀圖
   - 範本系統

4. **進階編輯**
   - 拖放重新排序
   - 批次操作
   - 搜尋和篩選節點

## ✅ 測試檢查清單

- [x] 資料庫欄位新增成功
- [x] API 端點正常運作
- [x] 前端組件正確顯示
- [x] 樹狀圖載入功能
- [x] 樹狀圖儲存功能
- [x] 無樹狀圖時的提示
- [x] 建立新樹狀圖功能
- [x] 自動儲存機制
- [x] 儲存狀態指示器
- [x] CSS 樣式正確應用

## 📝 相關文件

- [心智圖操作模組-使用指南.md](./心智圖操作模組-使用指南.md)
- [專案主視窗實作完成.md](./心智圖管理系統實作完成.md)
- [Asset Naming Guide](./asset-naming-guide.md)

---

**實作日期**: 2024-01-15  
**版本**: 1.0.0  
**狀態**: ✅ 完成並測試
