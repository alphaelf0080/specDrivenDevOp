# å°ˆæ¡ˆæ¨¹ç‹€åœ–æ•´åˆå®Œæˆ

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå°‡æ¨¹ç‹€åœ–ç·¨è¼¯å™¨æ•´åˆåˆ°å°ˆæ¡ˆä¸»è¦–çª—çš„é»ƒè‰²ç·¨è¼¯å€åŸŸï¼Œä¸¦å¯¦ç¾èˆ‡è³‡æ–™åº«çš„å®Œæ•´ç¶å®šã€‚

## âœ¨ åŠŸèƒ½ç‰¹é»

### 1. æ¨¹ç‹€åœ–é¡¯ç¤º
- âœ… å°ˆæ¡ˆä¸»è¦–çª—é»ƒè‰²å€åŸŸé¡¯ç¤ºæ¨¹ç‹€åœ–ç·¨è¼¯å™¨
- âœ… è‡ªå‹•è¼‰å…¥å°ˆæ¡ˆçš„æ¨¹ç‹€åœ–è³‡æ–™
- âœ… ç„¡æ¨¹ç‹€åœ–æ™‚é¡¯ç¤ºå»ºç«‹æç¤º

### 2. è³‡æ–™ç¶å®š
- âœ… æ¨¹ç‹€åœ–è³‡æ–™å„²å­˜åœ¨ `projects` è¡¨çš„ `tree_data` æ¬„ä½ï¼ˆJSONBï¼‰
- âœ… æ¨¹ç‹€åœ–é…ç½®å„²å­˜åœ¨ `tree_config` æ¬„ä½ï¼ˆJSONBï¼‰
- âœ… ç‰ˆæœ¬è¿½è¹¤ï¼š`tree_version`ï¼ˆæ¯æ¬¡æ›´æ–°è‡ªå‹•+1ï¼‰
- âœ… æ™‚é–“æˆ³è¨˜ï¼š`tree_updated_at`ï¼ˆè¨˜éŒ„æœ€å¾Œæ›´æ–°æ™‚é–“ï¼‰

### 3. è‡ªå‹•å„²å­˜
- âœ… ç¯€é»ç·¨è¼¯å¾Œè‡ªå‹•å„²å­˜åˆ°è³‡æ–™åº«
- âœ… é¡¯ç¤ºå„²å­˜ç‹€æ…‹æŒ‡ç¤ºå™¨
- âœ… éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒè¨˜éŒ„

## ğŸ—„ï¸ è³‡æ–™åº«çµæ§‹

### Projects è¡¨æ–°å¢æ¬„ä½

```sql
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_data JSONB;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_config JSONB;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_version INTEGER DEFAULT 1;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tree_updated_at TIMESTAMP WITH TIME ZONE;

-- GIN ç´¢å¼•ç”¨æ–¼é«˜æ•ˆæŸ¥è©¢ JSONB è³‡æ–™
CREATE INDEX IF NOT EXISTS idx_projects_tree_data ON projects USING GIN (tree_data);
CREATE INDEX IF NOT EXISTS idx_projects_tree_config ON projects USING GIN (tree_config);
```

### è³‡æ–™çµæ§‹ç¯„ä¾‹

```typescript
interface Project {
  id: number;
  name: string;
  // ... å…¶ä»–æ¬„ä½
  tree_data?: TreeNode | null;          // æ¨¹ç‹€åœ–çµæ§‹
  tree_config?: Record<string, unknown> | null;  // æ¨¹ç‹€åœ–é…ç½®
  tree_version?: number;                // ç‰ˆæœ¬è™Ÿ
  tree_updated_at?: string;             // æœ€å¾Œæ›´æ–°æ™‚é–“
}

interface TreeNode {
  id: string;
  label: string;
  children?: TreeNode[];
  // ... å…¶ä»–ç¯€é»å±¬æ€§
}
```

## ğŸ”Œ API ç«¯é»

### æ›´æ–°æ¨¹ç‹€åœ–è³‡æ–™
**PUT** `/api/projects/:id/tree`

#### è«‹æ±‚ç¯„ä¾‹
```json
{
  "tree_data": {
    "id": "root",
    "label": "å°ˆæ¡ˆæ ¹ç¯€é»",
    "children": [...]
  },
  "tree_config": {
    "direction": "LR",
    "nodeWidth": 200
  }
}
```

#### å›æ‡‰ç¯„ä¾‹
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "ç¯„ä¾‹å°ˆæ¡ˆ",
    "tree_data": {...},
    "tree_config": {...},
    "tree_version": 3,
    "tree_updated_at": "2024-01-15T10:30:00Z"
  },
  "message": "æ¨¹ç‹€åœ–å·²æ›´æ–°"
}
```

## ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆ

### 1. è³‡æ–™åº«é…ç½®
- `server/config/table.config.ts`
  - æ–°å¢ 4 å€‹æ¨¹ç‹€åœ–ç›¸é—œæ¬„ä½
  - æ–°å¢ 2 å€‹ GIN ç´¢å¼•

### 2. å¾Œç«¯ API
- `server/routes/projects.ts`
  - æ–°å¢ `PUT /api/projects/:id/tree` ç«¯é»
  - å¯¦ç¾æ¨¹ç‹€åœ–è³‡æ–™æ›´æ–°é‚è¼¯
  - è‡ªå‹•ç‰ˆæœ¬è™Ÿéå¢

### 3. å‰ç«¯çµ„ä»¶
- `client/components/Project/ProjectMainWindow.tsx`
  - æ–°å¢ `treeData` ç‹€æ…‹ç®¡ç†
  - å¯¦ç¾ `handleTreeChange` è‡ªå‹•å„²å­˜
  - æ•´åˆ `TreeDiagram` çµ„ä»¶
  - æ–°å¢è¼‰å…¥/å„²å­˜ç‹€æ…‹æŒ‡ç¤º

### 4. æ¨£å¼æª”æ¡ˆ
- `client/components/Project/ProjectMainWindow.css`
  - æ–°å¢ `.tree-diagram-container` æ¨£å¼
  - æ–°å¢ `.saving-indicator` æ¨£å¼
  - æ–°å¢ `.no-tree-placeholder` æ¨£å¼

## ğŸš€ ä½¿ç”¨æ–¹å¼

### é–‹å•Ÿå°ˆæ¡ˆæ¨¹ç‹€åœ–
1. å¾é¦–é é»æ“Šå°ˆæ¡ˆå¡ç‰‡
2. å°ˆæ¡ˆä¸»è¦–çª—è‡ªå‹•é–‹å•Ÿ
3. é»ƒè‰²ç·¨è¼¯å€åŸŸé¡¯ç¤ºæ¨¹ç‹€åœ–ç·¨è¼¯å™¨

### å»ºç«‹æ–°æ¨¹ç‹€åœ–
1. è‹¥å°ˆæ¡ˆæ²’æœ‰æ¨¹ç‹€åœ–ï¼Œæœƒé¡¯ç¤ºã€Œå»ºç«‹æ–°æ¨¹ç‹€åœ–ã€æŒ‰éˆ•
2. é»æ“ŠæŒ‰éˆ•å»ºç«‹åˆå§‹æ¨¹ç‹€åœ–
3. é–‹å§‹ç·¨è¼¯ç¯€é»

### ç·¨è¼¯æ¨¹ç‹€åœ–
1. é»æ“Šç¯€é»é€²è¡Œç·¨è¼¯
2. æ–°å¢å­ç¯€é»
3. åˆªé™¤ç¯€é»
4. æ‰€æœ‰è®Šæ›´è‡ªå‹•å„²å­˜

### æŸ¥çœ‹å„²å­˜ç‹€æ…‹
- ç·¨è¼¯æ™‚å³ä¸Šè§’é¡¯ç¤ºã€Œâ³ å„²å­˜ä¸­...ã€
- å„²å­˜å®Œæˆå¾Œè‡ªå‹•éš±è—

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### ç‹€æ…‹ç®¡ç†
```typescript
const [treeData, setTreeData] = useState<TreeNode | null>(null);
const [saving, setSaving] = useState(false);
```

### è¼‰å…¥æ¨¹ç‹€åœ–
```typescript
const loadProject = async () => {
  const result = await fetch(`/api/projects/${projectId}`);
  const data = result.json();
  if (data.tree_data) {
    setTreeData(data.tree_data);
  }
};
```

### è‡ªå‹•å„²å­˜
```typescript
const handleTreeChange = async (nodeId: string, updates: Partial<TreeNode>) => {
  // 1. æ›´æ–°æœ¬åœ°ç‹€æ…‹
  const updatedTree = updateNodeRecursive(treeData);
  setTreeData(updatedTree);
  
  // 2. å„²å­˜åˆ°è³‡æ–™åº«
  await fetch(`/api/projects/${projectId}/tree`, {
    method: 'PUT',
    body: JSON.stringify({ tree_data: updatedTree })
  });
};
```

## ğŸ“Š æ•ˆèƒ½å„ªåŒ–

### 1. JSONB ç´¢å¼•
- ä½¿ç”¨ GIN ç´¢å¼•åŠ é€Ÿ JSONB æŸ¥è©¢
- æ”¯æ´æ¨¹ç‹€åœ–è³‡æ–™çš„é«˜æ•ˆæœå°‹

### 2. ç‰ˆæœ¬æ§åˆ¶
- `tree_version` æ¬„ä½è¿½è¹¤è®Šæ›´
- å¯ç”¨æ–¼å¯¦ç¾æ¨‚è§€é–å®š
- æ”¯æ´ç‰ˆæœ¬æ¯”å°å’Œè¡çªåµæ¸¬

### 3. æ™‚é–“æˆ³è¨˜
- `tree_updated_at` è¨˜éŒ„æœ€å¾Œä¿®æ”¹æ™‚é–“
- æ”¯æ´æ’åºå’Œç¯©é¸
- å¯ç”¨æ–¼é¡¯ç¤ºã€Œæœ€è¿‘ç·¨è¼¯ã€è³‡è¨Š

## ğŸ¯ æœªä¾†æ“´å±•

### å¯èƒ½çš„å¢å¼·åŠŸèƒ½
1. **ç‰ˆæœ¬æ­·å²**
   - è¨˜éŒ„æ¯å€‹ç‰ˆæœ¬çš„æ¨¹ç‹€åœ–å¿«ç…§
   - æ”¯æ´ç‰ˆæœ¬å›æº¯
   - æ¯”è¼ƒä¸åŒç‰ˆæœ¬çš„å·®ç•°

2. **å”ä½œç·¨è¼¯**
   - WebSocket å³æ™‚åŒæ­¥
   - å¤šäººåŒæ™‚ç·¨è¼¯
   - è¡çªè§£æ±ºæ©Ÿåˆ¶

3. **åŒ¯å…¥/åŒ¯å‡º**
   - åŒ¯å‡ºç‚º JSON/åœ–ç‰‡
   - å¾å…¶ä»–å°ˆæ¡ˆåŒ¯å…¥æ¨¹ç‹€åœ–
   - ç¯„æœ¬ç³»çµ±

4. **é€²éšç·¨è¼¯**
   - æ‹–æ”¾é‡æ–°æ’åº
   - æ‰¹æ¬¡æ“ä½œ
   - æœå°‹å’Œç¯©é¸ç¯€é»

## âœ… æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [x] è³‡æ–™åº«æ¬„ä½æ–°å¢æˆåŠŸ
- [x] API ç«¯é»æ­£å¸¸é‹ä½œ
- [x] å‰ç«¯çµ„ä»¶æ­£ç¢ºé¡¯ç¤º
- [x] æ¨¹ç‹€åœ–è¼‰å…¥åŠŸèƒ½
- [x] æ¨¹ç‹€åœ–å„²å­˜åŠŸèƒ½
- [x] ç„¡æ¨¹ç‹€åœ–æ™‚çš„æç¤º
- [x] å»ºç«‹æ–°æ¨¹ç‹€åœ–åŠŸèƒ½
- [x] è‡ªå‹•å„²å­˜æ©Ÿåˆ¶
- [x] å„²å­˜ç‹€æ…‹æŒ‡ç¤ºå™¨
- [x] CSS æ¨£å¼æ­£ç¢ºæ‡‰ç”¨

## ğŸ“ ç›¸é—œæ–‡ä»¶

- [å¿ƒæ™ºåœ–æ“ä½œæ¨¡çµ„-ä½¿ç”¨æŒ‡å—.md](./å¿ƒæ™ºåœ–æ“ä½œæ¨¡çµ„-ä½¿ç”¨æŒ‡å—.md)
- [å°ˆæ¡ˆä¸»è¦–çª—å¯¦ä½œå®Œæˆ.md](./å¿ƒæ™ºåœ–ç®¡ç†ç³»çµ±å¯¦ä½œå®Œæˆ.md)
- [Asset Naming Guide](./asset-naming-guide.md)

---

**å¯¦ä½œæ—¥æœŸ**: 2024-01-15  
**ç‰ˆæœ¬**: 1.0.0  
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦æ¸¬è©¦
