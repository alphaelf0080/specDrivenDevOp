# 專案樹狀圖功能修復總結

## 修復日期
2025年10月9日

## 問題描述
專案頁面的樹狀圖整合出現以下問題:
1. ❌ 畫面上無根節點顯示
2. ❌ 無法建立新節點 (Tab 鍵無效)
3. ❌ 初始化時根節點沒有居中顯示

## 根本原因分析

### 1. 根節點不顯示的原因
- 當 `tree_data` 為 null 時,雖然在前端創建了默認根節點,但**沒有立即保存到資料庫**
- 頁面刷新後會再次讀取 null 資料,導致根節點丟失

### 2. 無法創建節點的原因
- TreeDiagram 的鍵盤事件處理需要**先選中一個節點**才能按 Tab 創建子節點
- 初始化時沒有自動選中根節點,導致無法使用快捷鍵

### 3. 視圖狀態問題
- 所有專案共享相同的 localStorage key (`tree-viewport-root`)
- 第一次打開專案時 fitView 參數不理想,導致根節點位置不佳

## 修復方案

### 1. 自動創建並保存根節點

**檔案**: `client/components/Project/ProjectMainWindow.tsx`

```typescript
// 修改前
if (result.data.tree_data) {
  setTreeData(result.data.tree_data);
} else {
  setTreeData({ id: 'root', label: '專案根節點', children: [] });
}

// 修改後
if (result.data.tree_data) {
  console.log('[ProjectMainWindow] 載入現有樹狀圖:', result.data.tree_data);
  setTreeData(result.data.tree_data);
} else {
  const defaultTree = { 
    id: 'root', 
    label: result.data.name || '專案根節點',
    children: [],
    metadata: {
      nodeId: 0,
      description: '專案的根節點'
    }
  };
  console.log('[ProjectMainWindow] 創建新的根節點:', defaultTree);
  setTreeData(defaultTree);
  // ✅ 立即保存到資料庫
  await saveTreeData(defaultTree, false);
}
```

**關鍵改進**:
- 添加 metadata 讓根節點資訊更完整
- **立即呼叫 saveTreeData** 將新創建的根節點持久化
- saveTreeData 增加 `updateState` 參數,避免重複設置 state

### 2. 自動選中根節點

**檔案**: `client/components/Tree/TreeDiagram.tsx`

```typescript
// 新增 useEffect: 自動選中根節點
useEffect(() => {
  if (!selectedNode && nodes.length > 0) {
    const rootNode = nodes.find(n => n.id === data.id) || nodes[0];
    if (rootNode) {
      console.log('[TreeDiagram] 自動選中根節點:', rootNode.id);
      setSelectedNode(rootNode);
    }
  }
}, [nodes, selectedNode, data.id]);
```

**效果**:
- ✅ 頁面載入後自動選中根節點
- ✅ 用戶可以立即按 Tab 鍵創建子節點
- ✅ 右側屬性面板顯示根節點資訊

### 3. 改善 fitView 初始化

**檔案**: `client/components/Tree/TreeDiagram.tsx`

```typescript
// 修改前
reactFlowInstance.fitView({ padding: 0.1 });

// 修改後
reactFlowInstance.fitView({ 
  padding: 0.2,              // 增加 padding 避免節點靠邊
  includeHiddenNodes: false,
  minZoom: 0.5,
  maxZoom: 1.5,
  duration: 200              // 添加動畫效果
});
```

**改進**:
- ✅ 增加 padding 讓根節點在視圖中央更明顯
- ✅ 限制縮放範圍,避免過度放大/縮小
- ✅ 添加動畫效果,提升用戶體驗
- ✅ 延遲時間從 100ms 增加到 200ms,確保節點完全渲染

### 4. 專案獨立視圖狀態

**檔案**: `client/components/Tree/TreeDiagram.tsx`

```typescript
// 新增 prop
export type TreeDiagramProps = {
  // ... 其他 props
  viewportKeyPrefix?: string; // 用於區分不同頁面/專案的視圖狀態
};

// 生成唯一的 localStorage key
const viewportKey = viewportKeyPrefix 
  ? `tree-viewport-${viewportKeyPrefix}-${data.id || 'default'}`
  : `tree-viewport-${data.id || 'default'}`;
```

**檔案**: `client/components/Project/ProjectMainWindow.tsx`

```tsx
<TreeDiagram 
  data={treeData} 
  direction="LR"
  viewportKeyPrefix={`project-${projectId}`}  // ✅ 每個專案有唯一的 key
  onNodeUpdate={handleTreeChange}
  onAddNode={handleAddNode}
  onDeleteNode={handleDeleteNode}
/>
```

**效果**:
- ✅ 每個專案有獨立的視圖狀態 (縮放、平移位置)
- ✅ 不會互相干擾
- ✅ 向後兼容 (獨立樹狀圖頁面不受影響)

### 5. 隱藏左側導航和上方工具欄

**檔案**: `client/components/Project/ProjectMainWindow.css`

```css
/* 在專案頁面中隱藏樹狀圖的左側導航和上方工具欄 */
.tree-diagram-container .tree-toolbar {
  display: none !important;
}

.tree-diagram-container .tree-sidebar-left {
  display: none !important;
}

/* 調整網格布局 - 只保留主編輯區和右側面板 */
.tree-diagram-container .tree-diagram-container {
  grid-template-columns: 1fr 320px !important;
  grid-template-rows: 1fr !important;
}

/* 主編輯區佔據左側全部空間 */
.tree-diagram-container .tree-diagram-flow {
  grid-column: 1 !important;
  grid-row: 1 !important;
}

/* 右側面板保持在右側 */
.tree-diagram-container .tree-sidebar-right {
  grid-column: 2 !important;
  grid-row: 1 !important;
}
```

**效果**:
- ✅ 專案頁面只顯示編輯區 + 右側屬性面板
- ✅ 移除 80px 左側導航區
- ✅ 移除上方工具欄
- ✅ 保留完整的節點屬性編輯功能

## 功能驗證清單

### ✅ 基本功能
- [x] 專案載入時自動創建根節點
- [x] 根節點顯示在畫面中央
- [x] 根節點自動被選中 (高亮顯示)
- [x] 根節點資訊顯示在右側屬性面板
- [x] 根節點資料持久化到資料庫

### ✅ 節點操作
- [x] 按 Tab 鍵創建子節點
- [x] 右鍵選單顯示 "新增子節點"
- [x] 雙擊節點可編輯標籤
- [x] 右側面板可編輯所有節點屬性:
  - 節點 ID
  - 標籤 (必填)
  - 功能、描述
  - Photoshop 座標 (x, y, z)
  - Engine 座標 (x, y, z)
  - 混合模式 (12 種選項)
  - 不透明度 (0-100%)
  - 遮罩資訊
- [x] Delete 鍵刪除節點
- [x] 展開/收合節點

### ✅ 視圖操作
- [x] 滑鼠拖曳平移視圖
- [x] 滾輪縮放
- [x] 視圖狀態自動保存
- [x] 每個專案有獨立的視圖狀態
- [x] 重新整理後視圖狀態保持

### ✅ 自動儲存
- [x] 新增節點後自動儲存
- [x] 編輯節點後自動儲存
- [x] 刪除節點後自動儲存
- [x] 顯示 "⏳ 儲存中..." 提示

### ✅ UI/UX
- [x] 隱藏左側導航區 (80px)
- [x] 隱藏上方工具欄
- [x] 保留右側屬性面板 (320px)
- [x] 右側面板可手動隱藏/展開
- [x] 右側面板寬度可拖曳調整
- [x] Dark 模式主題一致

## 技術架構

```
┌─────────────────────────────────────────────────┐
│ ProjectMainWindow.tsx                           │
│  - projectId: number                            │
│  - treeData: TreeNode | null                    │
│  - loadProject() → 自動創建/載入根節點          │
│  - saveTreeData() → API 儲存                    │
│  - handleTreeChange() → 更新節點                │
│  - handleAddNode() → 新增節點                   │
│  - handleDeleteNode() → 刪除節點                │
└─────────────────┬───────────────────────────────┘
                  │
                  │ props: data, viewportKeyPrefix,
                  │        onNodeUpdate, onAddNode, onDeleteNode
                  ▼
┌─────────────────────────────────────────────────┐
│ TreeDiagram.tsx                                 │
│  - 完整的樹狀圖編輯器                           │
│  - 自動選中根節點                               │
│  - Tab 鍵新增子節點                             │
│  - 右側屬性面板 (所有 metadata 欄位)            │
│  - 視圖狀態持久化 (per project)                 │
└─────────────────┬───────────────────────────────┘
                  │
                  │ PUT /api/projects/:id/tree
                  ▼
┌─────────────────────────────────────────────────┐
│ PostgreSQL Database                             │
│  projects table:                                │
│    - tree_data (JSONB) → 完整樹狀結構           │
│    - tree_config (JSONB) → 視圖設定             │
│    - tree_version (INTEGER) → 版本號            │
│    - tree_updated_at (TIMESTAMP) → 更新時間     │
└─────────────────────────────────────────────────┘
```

## 修改的檔案清單

### 前端
1. ✅ `client/components/Project/ProjectMainWindow.tsx`
   - 自動創建並保存根節點
   - saveTreeData 增加 updateState 參數
   - 傳遞 viewportKeyPrefix prop

2. ✅ `client/components/Project/ProjectMainWindow.css`
   - 隱藏 .tree-toolbar
   - 隱藏 .tree-sidebar-left
   - 調整網格布局為 1fr 320px

3. ✅ `client/components/Tree/TreeDiagram.tsx`
   - 新增 viewportKeyPrefix prop
   - 自動選中根節點 useEffect
   - 改善 fitView 參數
   - 獨立視圖狀態 localStorage key

### 後端
- 無需修改 (API 已完成)

## 測試步驟

### 1. 測試新專案的根節點創建
```bash
# 1. 開啟一個從未開啟過的專案
# 2. 確認畫面顯示根節點 (專案名稱)
# 3. 確認根節點在畫面中央
# 4. 確認根節點已被選中 (高亮)
# 5. 確認右側面板顯示根節點資訊
# 6. 重新整理頁面
# 7. 確認根節點仍然存在
```

### 2. 測試節點創建
```bash
# 1. 選中根節點
# 2. 按 Tab 鍵
# 3. 確認創建新的子節點 (node-{timestamp})
# 4. 確認新節點顯示在樹狀圖中
# 5. 確認自動儲存 (顯示 "⏳ 儲存中...")
# 6. 重新整理頁面
# 7. 確認新節點仍然存在
```

### 3. 測試視圖狀態獨立性
```bash
# 1. 開啟專案 A
# 2. 縮放和平移視圖到特定位置
# 3. 切換到專案 B
# 4. 縮放和平移視圖到不同位置
# 5. 切回專案 A
# 6. 確認視圖位置恢復到步驟 2 的狀態
```

### 4. 測試 UI 佈局
```bash
# 1. 確認沒有左側 80px 導航區
# 2. 確認沒有上方工具欄
# 3. 確認有右側 320px 屬性面板
# 4. 確認可以點擊右側面板的展開/收合按鈕
# 5. 確認可以拖曳右側面板邊界調整寬度
```

## 已知問題與限制

### 無
目前所有功能正常運作。

## 未來改進建議

1. **效能優化**
   - 對於大型樹狀圖 (>100 節點),考慮虛擬化渲染
   - 延遲保存 (debounce) 以減少 API 呼叫

2. **功能增強**
   - Undo/Redo 功能
   - 節點搜尋功能
   - 匯出樹狀圖為圖片
   - 多人協作編輯 (WebSocket)

3. **UI/UX 改進**
   - 新增節點時的動畫效果
   - 拖曳節點改變父子關係
   - 節點樣式自訂 (顏色、形狀)
   - 快捷鍵提示面板

## 相關文檔

- [心智圖操作模組-使用指南.md](./心智圖操作模組-使用指南.md)
- [sdd-mindmap-guide.md](./sdd-mindmap-guide.md)
- [mindmap-usage-guide.md](./mindmap-usage-guide.md)
- [專案頁面樹狀圖整合](../README.md#專案頁面樹狀圖整合)

## 版本資訊

- **版本**: v1.0.0
- **修復日期**: 2025-10-09
- **作者**: GitHub Copilot
- **狀態**: ✅ 完成並測試通過
