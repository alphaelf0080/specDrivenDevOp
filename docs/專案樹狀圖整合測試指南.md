# 專案樹狀圖整合 - 測試指南

## 🧪 功能測試步驟

### 前置準備

1. **確認資料庫已更新**
   ```bash
   npm run db:create-tables
   ```
   確認 projects 表已包含：
   - `tree_data` (JSONB)
   - `tree_config` (JSONB)
   - `tree_version` (INTEGER)
   - `tree_updated_at` (TIMESTAMP)

2. **啟動開發伺服器**
   ```bash
   # 終端機 1: 後端伺服器
   npm run server

   # 終端機 2: 前端伺服器
   npm run dev
   ```

---

## 📝 測試案例

### 測試 1: 載入既有專案（無樹狀圖）

**步驟**:
1. 開啟首頁 `http://localhost:5030`
2. 點擊任一專案卡片
3. 專案主視窗在新視窗開啟

**預期結果**:
- ✅ 主視窗正確顯示四色布局
- ✅ 黃色編輯區顯示「尚無樹狀圖資料」提示
- ✅ 顯示「建立新樹狀圖」按鈕

---

### 測試 2: 建立新樹狀圖

**步驟**:
1. 在無樹狀圖的專案中
2. 點擊「建立新樹狀圖」按鈕

**預期結果**:
- ✅ 樹狀圖編輯器載入
- ✅ 顯示根節點（專案名稱）
- ✅ 可以新增子節點
- ✅ 右上角短暫顯示「⏳ 儲存中...」

**資料庫檢查**:
```sql
SELECT id, name, tree_data, tree_version, tree_updated_at 
FROM projects 
WHERE id = <專案ID>;
```
- ✅ `tree_data` 不為 NULL
- ✅ `tree_version` = 1
- ✅ `tree_updated_at` 為當前時間

---

### 測試 3: 編輯樹狀圖節點

**步驟**:
1. 在有樹狀圖的專案中
2. 點擊根節點
3. 新增子節點
4. 編輯節點名稱
5. 刪除節點

**預期結果**:
- ✅ 每次操作後自動儲存
- ✅ 顯示儲存指示器
- ✅ 頁面重新整理後資料保留

**資料庫檢查**:
```sql
SELECT tree_version, tree_updated_at 
FROM projects 
WHERE id = <專案ID>;
```
- ✅ `tree_version` 每次編輯後遞增
- ✅ `tree_updated_at` 更新為最新時間

---

### 測試 4: 重新載入專案

**步驟**:
1. 編輯樹狀圖
2. 關閉專案視窗
3. 從首頁重新開啟同一專案

**預期結果**:
- ✅ 樹狀圖正確載入
- ✅ 顯示之前編輯的內容
- ✅ 節點結構完整

---

### 測試 5: API 端點測試

**使用 curl 測試**:

1. **更新樹狀圖**:
   ```bash
   curl -X PUT http://localhost:5010/api/projects/1/tree \
     -H "Content-Type: application/json" \
     -d '{
       "tree_data": {
         "id": "root",
         "label": "測試專案",
         "children": [
           {"id": "child1", "label": "子節點1"}
         ]
       }
     }'
   ```

   **預期回應**:
   ```json
   {
     "success": true,
     "data": {
       "id": 1,
       "tree_data": {...},
       "tree_version": 2,
       "tree_updated_at": "2024-01-15T..."
     },
     "message": "樹狀圖已更新"
   }
   ```

2. **載入專案（含樹狀圖）**:
   ```bash
   curl http://localhost:5010/api/projects/1
   ```

   **預期回應**:
   ```json
   {
     "success": true,
     "data": {
       "id": 1,
       "name": "測試專案",
       "tree_data": {...},
       "tree_config": null,
       "tree_version": 2,
       "tree_updated_at": "2024-01-15T..."
     }
   }
   ```

---

### 測試 6: 錯誤處理

**測試情境**:

1. **專案不存在**:
   ```bash
   curl -X PUT http://localhost:5010/api/projects/99999/tree \
     -H "Content-Type: application/json" \
     -d '{"tree_data": {}}'
   ```
   **預期**: 404 錯誤，訊息「專案不存在」

2. **無效的 JSON**:
   ```bash
   curl -X PUT http://localhost:5010/api/projects/1/tree \
     -H "Content-Type: application/json" \
     -d 'invalid json'
   ```
   **預期**: 400 或 500 錯誤

---

## 🔍 除錯檢查清單

### 前端問題

**樹狀圖不顯示**:
1. 檢查瀏覽器控制台錯誤
2. 確認 `TreeDiagram` 組件正確導入
3. 檢查 `treeData` 狀態是否正確設定

**儲存失敗**:
1. 檢查網路請求（DevTools → Network）
2. 確認 API URL 正確（`/api/projects/:id/tree`）
3. 檢查請求 payload 格式

### 後端問題

**API 錯誤**:
1. 檢查伺服器終端機日誌
2. 確認資料庫連線正常
3. 驗證 SQL 語法

**資料庫問題**:
```sql
-- 檢查欄位是否存在
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'projects' 
  AND column_name LIKE 'tree_%';

-- 檢查索引是否建立
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'projects' 
  AND indexname LIKE '%tree%';
```

---

## 📊 效能測試

### 測試大型樹狀圖

**建立測試資料**:
```typescript
// 生成 100 個節點的樹狀圖
const largeTree = {
  id: 'root',
  label: '大型樹狀圖',
  children: Array.from({ length: 10 }, (_, i) => ({
    id: `branch-${i}`,
    label: `分支 ${i}`,
    children: Array.from({ length: 10 }, (_, j) => ({
      id: `leaf-${i}-${j}`,
      label: `葉節點 ${i}-${j}`
    }))
  }))
};
```

**檢查項目**:
- ✅ 載入時間 < 2 秒
- ✅ 編輯操作流暢
- ✅ 儲存時間 < 1 秒
- ✅ JSONB 查詢效率（使用 GIN 索引）

---

## ✅ 驗收標準

### 必須通過的測試

- [ ] 測試 1: 載入無樹狀圖專案
- [ ] 測試 2: 建立新樹狀圖
- [ ] 測試 3: 編輯節點
- [ ] 測試 4: 重新載入保留資料
- [ ] 測試 5: API 端點正常
- [ ] 測試 6: 錯誤處理正確

### 資料庫驗證

- [ ] 4 個新欄位存在
- [ ] 2 個 GIN 索引建立
- [ ] tree_version 自動遞增
- [ ] tree_updated_at 自動更新

### UI/UX 驗證

- [ ] 樹狀圖正確顯示在黃色區域
- [ ] 儲存指示器正常運作
- [ ] 無樹狀圖時顯示提示
- [ ] 建立按鈕功能正常

---

## 🐛 已知問題

目前無已知問題。

---

## 📚 相關資源

- [專案樹狀圖整合完成.md](./專案樹狀圖整合完成.md) - 完整實作文件
- [TreeDiagram Component](../client/components/Tree/TreeDiagram.tsx) - 樹狀圖組件
- [Projects API](../server/routes/projects.ts) - API 實作

---

**測試版本**: 1.0.0  
**最後更新**: 2024-01-15
