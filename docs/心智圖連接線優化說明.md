# 心智圖連接線優化說明

## 📅 更新日期
2025-10-07

## 🎯 優化目標
解決心智圖中左側節點的連接線打結問題，實現根據節點位置動態調整連接點（Handle）方向。

## ✨ 主要改進

### 1. 動態 Handle 位置調整

#### MindMapNode.tsx
- **位置判斷**: 根據節點的 `xPos` 座標判斷節點在根節點的左側 (xPos < 0) 還是右側 (xPos > 0)
- **動態 Handle**:
  - **左側節點**: 
    - Target Handle 在右邊（接收來自右邊根節點的連線）
    - Source Handle 在左邊（發出到左邊的子節點）
  - **右側節點**:
    - Target Handle 在左邊（接收來自左邊根節點的連線）
    - Source Handle 在右邊（發出到右邊的子節點）

#### 根節點特殊處理
- 根節點只有 Source Handles，沒有 Target Handle
- 提供四個方向的 Source Handles:
  - `source-top` (上方)
  - `source-right` (右邊)
  - `source-bottom` (下方)
  - `source-left` (左邊)

### 2. 智能 Handle 選擇

#### useMindMap.ts
新增輔助函數 `determineHandles()`:

```typescript
const determineHandles = (sourceNode: Node, targetNode: Node): { sourceHandle: string; targetHandle: string }
```

- 計算目標節點相對於根節點的角度
- 根據角度自動選擇最合適的 source handle:
  - -45° ~ 45°: `source-right`
  - 45° ~ 135°: `source-bottom`
  - 135° ~ -135°: `source-left`
  - -135° ~ -45°: `source-top`

### 3. 視覺優化

#### MindMapNode.css
- **Target Handle**: 綠色 (#10b981)
- **Source Handle**: 橙色 (#f59e0b)
- 懸停時放大效果，更容易識別連接點

## 🔧 技術實現

### 節點類型判斷
```typescript
const isRoot = nodeType === 'root' || data.id === 'root';
const isLeftSide = (xPos ?? 0) < 0;
```

### 位置計算
```typescript
const angle = Math.atan2(y, x) * (180 / Math.PI);
```

### Handle ID 規範
- 普通節點: `target`, `source`
- 根節點: `source-top`, `source-right`, `source-bottom`, `source-left`

## 📊 改進效果

### Before (之前)
- ❌ 左側節點的連接線從右邊連到右邊，造成線條交叉
- ❌ 所有節點使用固定的 Handle 位置
- ❌ 連接線打結，視覺混亂

### After (之後)
- ✅ 左側節點從左邊發出連線，右側節點從右邊發出
- ✅ 根節點智能選擇最近的 Handle 連接
- ✅ 連接線清晰流暢，不會交叉打結
- ✅ 放射狀佈局更加美觀

## 🎨 配色說明

### 節點類型色系
1. **方案概述** - 藍色系 (#3b82f6)
2. **角色職責** - 綠色系 (#10b981)
3. **開發流程** - 橙色系 (#f59e0b)
4. **工具技術棧** - 紫色系 (#8b5cf6)
5. **品質保證** - 粉色系 (#ec4899)
6. **監管合規** - 紅色系 (#ef4444)
7. **實施路線圖** - 青色系 (#06b6d4)

### Handle 色系
- **Target Handle** (接收端): 綠色 #10b981
- **Source Handle** (發送端): 橙色 #f59e0b

## 🚀 使用方式

1. **啟動伺服器**
   ```bash
   npm run dev
   ```

2. **訪問應用**
   - 前端: http://localhost:5030
   - 後端: http://localhost:5010

3. **查看效果**
   - 開啟 "SDD 規格驅動開發方案" 心智圖
   - 觀察左右兩側節點的連接線方向
   - 拖曳節點時連接線會自動調整

## 📝 注意事項

1. **xPos 和 yPos**: ReactFlow 自動提供節點的絕對位置
2. **Handle ID**: 必須在 Edge 中明確指定 `sourceHandle` 和 `targetHandle`
3. **調試日誌**: 控制台會顯示每個節點的位置和 Handle 配置
4. **性能**: 使用 `React.memo` 優化渲染性能

## 🔮 未來優化

- [ ] 添加動畫效果，讓連接線變化更平滑
- [ ] 支持手動調整 Handle 位置
- [ ] 添加連接線箭頭樣式自定義
- [ ] 優化拖曳時的即時重新計算

---

**變更檔案清單**:
- ✅ `client/components/MindMap/MindMapNode.tsx`
- ✅ `client/components/MindMap/MindMapNode.css`
- ✅ `client/hooks/useMindMap.ts`
- ✅ `data/sdd-mindmap-layout.json`
