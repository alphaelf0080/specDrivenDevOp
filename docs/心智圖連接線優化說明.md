# å¿ƒæ™ºåœ–é€£æ¥ç·šå„ªåŒ–èªªæ˜

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-10-07

## ğŸ¯ å„ªåŒ–ç›®æ¨™
è§£æ±ºå¿ƒæ™ºåœ–ä¸­å·¦å´ç¯€é»çš„é€£æ¥ç·šæ‰“çµå•é¡Œï¼Œå¯¦ç¾æ ¹æ“šç¯€é»ä½ç½®å‹•æ…‹èª¿æ•´é€£æ¥é»ï¼ˆHandleï¼‰æ–¹å‘ã€‚

## âœ¨ ä¸»è¦æ”¹é€²

### 1. å‹•æ…‹ Handle ä½ç½®èª¿æ•´

#### MindMapNode.tsx
- **ä½ç½®åˆ¤æ–·**: æ ¹æ“šç¯€é»çš„ `xPos` åº§æ¨™åˆ¤æ–·ç¯€é»åœ¨æ ¹ç¯€é»çš„å·¦å´ (xPos < 0) é‚„æ˜¯å³å´ (xPos > 0)
- **å‹•æ…‹ Handle**:
  - **å·¦å´ç¯€é»**: 
    - Target Handle åœ¨å³é‚Šï¼ˆæ¥æ”¶ä¾†è‡ªå³é‚Šæ ¹ç¯€é»çš„é€£ç·šï¼‰
    - Source Handle åœ¨å·¦é‚Šï¼ˆç™¼å‡ºåˆ°å·¦é‚Šçš„å­ç¯€é»ï¼‰
  - **å³å´ç¯€é»**:
    - Target Handle åœ¨å·¦é‚Šï¼ˆæ¥æ”¶ä¾†è‡ªå·¦é‚Šæ ¹ç¯€é»çš„é€£ç·šï¼‰
    - Source Handle åœ¨å³é‚Šï¼ˆç™¼å‡ºåˆ°å³é‚Šçš„å­ç¯€é»ï¼‰

#### æ ¹ç¯€é»ç‰¹æ®Šè™•ç†
- æ ¹ç¯€é»åªæœ‰ Source Handlesï¼Œæ²’æœ‰ Target Handle
- æä¾›å››å€‹æ–¹å‘çš„ Source Handles:
  - `source-top` (ä¸Šæ–¹)
  - `source-right` (å³é‚Š)
  - `source-bottom` (ä¸‹æ–¹)
  - `source-left` (å·¦é‚Š)

### 2. æ™ºèƒ½ Handle é¸æ“‡

#### useMindMap.ts
æ–°å¢è¼”åŠ©å‡½æ•¸ `determineHandles()`:

```typescript
const determineHandles = (sourceNode: Node, targetNode: Node): { sourceHandle: string; targetHandle: string }
```

- è¨ˆç®—ç›®æ¨™ç¯€é»ç›¸å°æ–¼æ ¹ç¯€é»çš„è§’åº¦
- æ ¹æ“šè§’åº¦è‡ªå‹•é¸æ“‡æœ€åˆé©çš„ source handle:
  - -45Â° ~ 45Â°: `source-right`
  - 45Â° ~ 135Â°: `source-bottom`
  - 135Â° ~ -135Â°: `source-left`
  - -135Â° ~ -45Â°: `source-top`

### 3. è¦–è¦ºå„ªåŒ–

#### MindMapNode.css
- **Target Handle**: ç¶ è‰² (#10b981)
- **Source Handle**: æ©™è‰² (#f59e0b)
- æ‡¸åœæ™‚æ”¾å¤§æ•ˆæœï¼Œæ›´å®¹æ˜“è­˜åˆ¥é€£æ¥é»

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### ç¯€é»é¡å‹åˆ¤æ–·
```typescript
const isRoot = nodeType === 'root' || data.id === 'root';
const isLeftSide = (xPos ?? 0) < 0;
```

### ä½ç½®è¨ˆç®—
```typescript
const angle = Math.atan2(y, x) * (180 / Math.PI);
```

### Handle ID è¦ç¯„
- æ™®é€šç¯€é»: `target`, `source`
- æ ¹ç¯€é»: `source-top`, `source-right`, `source-bottom`, `source-left`

## ğŸ“Š æ”¹é€²æ•ˆæœ

### Before (ä¹‹å‰)
- âŒ å·¦å´ç¯€é»çš„é€£æ¥ç·šå¾å³é‚Šé€£åˆ°å³é‚Šï¼Œé€ æˆç·šæ¢äº¤å‰
- âŒ æ‰€æœ‰ç¯€é»ä½¿ç”¨å›ºå®šçš„ Handle ä½ç½®
- âŒ é€£æ¥ç·šæ‰“çµï¼Œè¦–è¦ºæ··äº‚

### After (ä¹‹å¾Œ)
- âœ… å·¦å´ç¯€é»å¾å·¦é‚Šç™¼å‡ºé€£ç·šï¼Œå³å´ç¯€é»å¾å³é‚Šç™¼å‡º
- âœ… æ ¹ç¯€é»æ™ºèƒ½é¸æ“‡æœ€è¿‘çš„ Handle é€£æ¥
- âœ… é€£æ¥ç·šæ¸…æ™°æµæš¢ï¼Œä¸æœƒäº¤å‰æ‰“çµ
- âœ… æ”¾å°„ç‹€ä½ˆå±€æ›´åŠ ç¾è§€

## ğŸ¨ é…è‰²èªªæ˜

### ç¯€é»é¡å‹è‰²ç³»
1. **æ–¹æ¡ˆæ¦‚è¿°** - è—è‰²ç³» (#3b82f6)
2. **è§’è‰²è·è²¬** - ç¶ è‰²ç³» (#10b981)
3. **é–‹ç™¼æµç¨‹** - æ©™è‰²ç³» (#f59e0b)
4. **å·¥å…·æŠ€è¡“æ£§** - ç´«è‰²ç³» (#8b5cf6)
5. **å“è³ªä¿è­‰** - ç²‰è‰²ç³» (#ec4899)
6. **ç›£ç®¡åˆè¦** - ç´…è‰²ç³» (#ef4444)
7. **å¯¦æ–½è·¯ç·šåœ–** - é’è‰²ç³» (#06b6d4)

### Handle è‰²ç³»
- **Target Handle** (æ¥æ”¶ç«¯): ç¶ è‰² #10b981
- **Source Handle** (ç™¼é€ç«¯): æ©™è‰² #f59e0b

## ğŸš€ ä½¿ç”¨æ–¹å¼

1. **å•Ÿå‹•ä¼ºæœå™¨**
   ```bash
   npm run dev
   ```

2. **è¨ªå•æ‡‰ç”¨**
   - å‰ç«¯: http://localhost:5030
   - å¾Œç«¯: http://localhost:5010

3. **æŸ¥çœ‹æ•ˆæœ**
   - é–‹å•Ÿ "SDD è¦æ ¼é©…å‹•é–‹ç™¼æ–¹æ¡ˆ" å¿ƒæ™ºåœ–
   - è§€å¯Ÿå·¦å³å…©å´ç¯€é»çš„é€£æ¥ç·šæ–¹å‘
   - æ‹–æ›³ç¯€é»æ™‚é€£æ¥ç·šæœƒè‡ªå‹•èª¿æ•´

## ğŸ“ æ³¨æ„äº‹é …

1. **xPos å’Œ yPos**: ReactFlow è‡ªå‹•æä¾›ç¯€é»çš„çµ•å°ä½ç½®
2. **Handle ID**: å¿…é ˆåœ¨ Edge ä¸­æ˜ç¢ºæŒ‡å®š `sourceHandle` å’Œ `targetHandle`
3. **èª¿è©¦æ—¥èªŒ**: æ§åˆ¶å°æœƒé¡¯ç¤ºæ¯å€‹ç¯€é»çš„ä½ç½®å’Œ Handle é…ç½®
4. **æ€§èƒ½**: ä½¿ç”¨ `React.memo` å„ªåŒ–æ¸²æŸ“æ€§èƒ½

## ğŸ”® æœªä¾†å„ªåŒ–

- [ ] æ·»åŠ å‹•ç•«æ•ˆæœï¼Œè®“é€£æ¥ç·šè®ŠåŒ–æ›´å¹³æ»‘
- [ ] æ”¯æŒæ‰‹å‹•èª¿æ•´ Handle ä½ç½®
- [ ] æ·»åŠ é€£æ¥ç·šç®­é ­æ¨£å¼è‡ªå®šç¾©
- [ ] å„ªåŒ–æ‹–æ›³æ™‚çš„å³æ™‚é‡æ–°è¨ˆç®—

---

**è®Šæ›´æª”æ¡ˆæ¸…å–®**:
- âœ… `client/components/MindMap/MindMapNode.tsx`
- âœ… `client/components/MindMap/MindMapNode.css`
- âœ… `client/hooks/useMindMap.ts`
- âœ… `data/sdd-mindmap-layout.json`
