# 樹狀圖嵌入模式與獨立模式分離

## 修改日期
2025年10月9日

## 問題描述
之前的修改導致樹狀圖在專案頁面和獨立頁面都使用相同的簡化布局,丟失了獨立頁面的完整功能。

## 需求
根據使用場景提供兩種不同的布局模式:

### 1. 獨立模式 (Standalone Mode)
用於獨立的樹狀圖頁面 (如 `/tree-demo`, `/tree-ui-layout` 等)

**布局**:
```
┌─────────────────────────────────────────────────────────┐
│ ⬅️ 返回首頁    樹枝圖              全部展開              │  ← 上方工具欄
├────┬────────────────────────────────────────┬───────────┤
│ 🔍 │                                        │           │
│ 📚 │                                        │  屬性面板  │
│ 🔖 │         樹狀圖編輯區                    │  (右側)   │
│ ⚙️ │         (主編輯區)                      │  320px    │
│ 💾 │                                        │           │
│ 🔗 │                                        │           │
└────┴────────────────────────────────────────┴───────────┘
 80px              1fr                         320px
```

**特色**:
- ✅ 左側導航區 (80px) - 提供過濾、圖層、書籤等工具
- ✅ 上方工具欄 - 返回首頁、全部展開等按鈕
- ✅ 主編輯區 - 樹狀圖展示和編輯
- ✅ 右側屬性面板 (320px) - 節點屬性編輯

### 2. 嵌入模式 (Embedded Mode)
用於專案頁面中嵌入的樹狀圖

**布局**:
```
┌───────────────────────────────────────┬───────────┐
│                                       │           │
│                                       │  屬性編輯  │
│         樹狀圖編輯區                   │  (右側)   │
│         (主編輯區)                     │  320px    │
│                                       │           │
│                                       │           │
└───────────────────────────────────────┴───────────┘
              1fr                        320px
```

**特色**:
- ✅ 無左側導航區 - 節省空間
- ✅ 無上方工具欄 - 簡潔設計
- ✅ 主編輯區 - 完整顯示樹狀圖
- ✅ 右側屬性編輯面板 (320px) - 保持編輯功能

---

## 實現方式

### 1. 添加 `embedded` 屬性

**檔案**: `client/components/Tree/TreeDiagram.tsx`

```typescript
export type TreeDiagramProps = {
  data: TreeNode;
  direction?: 'LR' | 'TB';
  // ... 其他屬性
  embedded?: boolean; // 🆕 是否為嵌入模式
};

export default function TreeDiagram({ 
  data, 
  direction = 'LR', 
  // ... 其他參數
  embedded = false  // 🆕 預設為獨立模式
}: TreeDiagramProps) {
  // ...
}
```

### 2. 動態調整網格布局

```typescript
const containerStyle = useMemo(() => {
  if (embedded) {
    // 嵌入模式: 只有主編輯區 + 右側面板
    return {
      gridTemplateColumns: `1fr ${isPanelOpen ? `${panelWidth}px` : '0px'}`,
      gridTemplateRows: '1fr',
    };
  }
  // 獨立模式: 左側導航 + 上方工具欄 + 主編輯區 + 右側面板
  return {
    gridTemplateColumns: `80px 1fr ${isPanelOpen ? `${panelWidth}px` : '0px'}`,
    gridTemplateRows: 'auto 1fr',
  };
}, [embedded, isPanelOpen, panelWidth]);
```

### 3. 條件渲染工具欄和左側導航

```tsx
return (
  <div className={`tree-diagram-container ${embedded ? 'embedded-mode' : 'standalone-mode'}`} 
       style={containerStyle}>
    {/* 工具列 - 只在非嵌入模式顯示 */}
    {!embedded && (
      <div className="tree-toolbar">
        {/* 工具欄內容 */}
      </div>
    )}

    {/* 左側導覽區 - 只在非嵌入模式顯示 */}
    {!embedded && (
      <div className="tree-sidebar-left">
        {/* 左側導航內容 */}
      </div>
    )}

    {/* 主編輯區 - 始終顯示 */}
    <div className="tree-diagram-flow">
      <ReactFlow {...props} />
    </div>

    {/* 右側屬性面板 - 始終顯示 */}
    <div className={`tree-sidebar-right ${isPanelOpen ? 'open' : 'collapsed'}`}>
      {/* 屬性面板內容 */}
    </div>
  </div>
);
```

---

## CSS 樣式調整

**檔案**: `client/components/Tree/TreeDiagram.css`

### 基礎容器樣式

```css
/* 基礎布局容器 */
.tree-diagram-container {
  width: 100%;
  height: 100%;
  display: grid;
  background: #0f172a;
  color: #e2e8f0;
  transition: grid-template-columns 0.3s ease;
}

/* 獨立模式 - 完整布局 */
.tree-diagram-container.standalone-mode {
  grid-template-columns: 80px 1fr 320px;
  grid-template-rows: auto 1fr;
}

/* 嵌入模式 - 簡化布局 */
.tree-diagram-container.embedded-mode {
  grid-template-columns: 1fr 320px;
  grid-template-rows: 1fr;
}
```

### 主編輯區位置調整

```css
/* 獨立模式的主編輯區 */
.tree-diagram-container.standalone-mode .tree-diagram-flow {
  grid-column: 2;  /* 第二欄 (在左側導航之後) */
  grid-row: 2;     /* 第二行 (在工具欄之後) */
  background: #1e293b;
  position: relative;
}

/* 嵌入模式的主編輯區 */
.tree-diagram-container.embedded-mode .tree-diagram-flow {
  grid-column: 1;  /* 第一欄 (無左側導航) */
  grid-row: 1;     /* 第一行 (無工具欄) */
  background: #1e293b;
  position: relative;
}
```

### 右側面板位置調整

```css
/* 獨立模式的右側面板 */
.tree-diagram-container.standalone-mode .tree-sidebar-right {
  grid-column: 3;
  grid-row: 2;
  /* ... 其他樣式 */
}

/* 嵌入模式的右側面板 */
.tree-diagram-container.embedded-mode .tree-sidebar-right {
  grid-column: 2;
  grid-row: 1;
  /* ... 其他樣式 */
}
```

---

## 使用方式

### 獨立樹狀圖頁面 (預設)

```tsx
// 不傳遞 embedded 屬性,使用預設值 false
<TreeDiagram 
  data={treeData}
  direction="LR"
  onNodeUpdate={handleUpdate}
  onAddNode={handleAdd}
  onDeleteNode={handleDelete}
/>
```

### 專案頁面嵌入

**檔案**: `client/components/Project/ProjectMainWindow.tsx`

```tsx
<TreeDiagram 
  data={treeData} 
  direction="LR"
  viewportKeyPrefix={`project-${projectId}`}
  embedded={true}  // 🔑 啟用嵌入模式
  onNodeUpdate={handleTreeChange}
  onAddNode={handleAddNode}
  onDeleteNode={handleDeleteNode}
/>
```

---

## 修改的檔案清單

### 前端組件

1. ✅ **client/components/Tree/TreeDiagram.tsx**
   - 添加 `embedded?: boolean` 屬性
   - 動態調整 `containerStyle`
   - 條件渲染工具欄和左側導航
   - 添加 CSS class: `embedded-mode` / `standalone-mode`

2. ✅ **client/components/Tree/TreeDiagram.css**
   - 新增 `.embedded-mode` 樣式
   - 新增 `.standalone-mode` 樣式
   - 調整主編輯區的 grid 位置
   - 調整右側面板的 grid 位置

3. ✅ **client/components/Project/ProjectMainWindow.tsx**
   - 傳遞 `embedded={true}` 屬性

4. ✅ **client/components/Project/ProjectMainWindow.css**
   - 移除不必要的覆蓋樣式 (已在 TreeDiagram 中處理)

---

## 對比表

| 特性 | 獨立模式 | 嵌入模式 |
|------|---------|---------|
| 左側導航 (80px) | ✅ 顯示 | ❌ 隱藏 |
| 上方工具欄 | ✅ 顯示 | ❌ 隱藏 |
| 主編輯區 | ✅ 顯示 | ✅ 顯示 |
| 右側屬性面板 (320px) | ✅ 顯示 | ✅ 顯示 |
| 網格列數 | 3 欄 | 2 欄 |
| 網格行數 | 2 行 | 1 行 |
| 總寬度 | 80px + 1fr + 320px | 1fr + 320px |
| 適用場景 | 獨立頁面 | 專案頁面嵌入 |

---

## 測試場景

### 1. 獨立模式測試

**測試頁面**: 
- `/tree-demo`
- `/tree-ui-layout`
- `/tree-ui-layout-rich`
- `/tree-psd-structure`

**檢查項目**:
- [x] 左側導航區顯示且功能正常
- [x] 上方工具欄顯示
- [x] "返回首頁" 按鈕可點擊
- [x] "全部展開" 按鈕可點擊
- [x] 主編輯區正常顯示樹狀圖
- [x] 右側屬性面板可展開/收合
- [x] 節點可以正常選中和編輯
- [x] 布局為 80px + 1fr + 320px

### 2. 嵌入模式測試

**測試頁面**: 
- 專案主視窗 (Project Main Window)
- URL: `/?view=project-page&id={projectId}`

**檢查項目**:
- [x] 左側導航區不顯示
- [x] 上方工具欄不顯示
- [x] 主編輯區佔據左側全部空間
- [x] 右側屬性編輯面板顯示
- [x] 根節點自動顯示在中央
- [x] Tab 鍵可創建子節點
- [x] 右鍵選單正常運作
- [x] 節點屬性可編輯
- [x] 布局為 1fr + 320px

---

## 效果預覽

### 獨立模式布局
```
┌─────────────────────────────────────────────────────────┐
│ [⬅️ 返回首頁]  樹枝圖                    [全部展開]      │
├────┬────────────────────────────────────────┬───────────┤
│ 🔍 │                                        │ 屬性面板   │
│ 📚 │              Root                      │ ┌────────┐│
│ 🔖 │            /  |  \                     │ │ ID: 0  ││
│ ⚙️ │          A    B    C                   │ │ 標籤:  ││
│ 💾 │         / \   |   / \                  │ │ Root   ││
│ 🔗 │        D   E  F  G   H                 │ │        ││
│    │                                        │ │ 功能:  ││
└────┴────────────────────────────────────────┴───────────┘
 80px              1fr                         320px
```

### 嵌入模式布局
```
┌───────────────────────────────────────┬───────────────┐
│                                       │ 屬性編輯       │
│              Root                     │ ┌────────────┐│
│            /  |  \                    │ │ 節點 ID    ││
│          A    B    C                  │ │ 標籤 (必填) ││
│         / \   |   / \                 │ │ 功能       ││
│        D   E  F  G   H                │ │ 描述       ││
│                                       │ │ Photoshop座標││
│                                       │ │ Engine座標  ││
│                                       │ │ 混合模式    ││
│                                       │ │ 不透明度    ││
└───────────────────────────────────────┴───────────────┘
              1fr                          320px
```

---

## 技術優勢

### 1. 代碼重用 ✅
- 單一 TreeDiagram 組件支持兩種模式
- 避免維護多個相似組件
- 減少代碼重複

### 2. 靈活性 🔧
- 通過簡單的 `embedded` 屬性切換模式
- 保持兩種模式的功能完整性
- 易於擴展新模式

### 3. 可維護性 📝
- 清晰的模式區分
- 統一的 CSS class 命名
- 易於理解和修改

### 4. 向後兼容 ⬅️
- 預設值為獨立模式 (`embedded = false`)
- 現有的獨立頁面無需修改
- 不影響現有功能

---

## 已知問題與限制

### 無
目前兩種模式都正常運作,無已知問題。

---

## 未來改進建議

### 1. 添加更多模式
```typescript
type TreeDiagramMode = 'standalone' | 'embedded' | 'compact' | 'readonly';

embedded?: TreeDiagramMode;
```

### 2. 自定義布局配置
```typescript
layoutConfig?: {
  showLeftNav?: boolean;
  showTopToolbar?: boolean;
  leftNavWidth?: number;
  rightPanelWidth?: number;
};
```

### 3. 響應式模式切換
```typescript
// 根據螢幕寬度自動切換模式
const isMobile = window.innerWidth < 768;
const mode = isMobile ? 'compact' : 'standalone';
```

---

## 相關文檔

- [專案樹狀圖功能修復.md](./專案樹狀圖功能修復.md)
- [TreeDiagram 組件文檔](../client/components/Tree/README.md)
- [專案主視窗設計](./專案主視窗設計.md)

---

## 版本資訊

- **版本**: v2.0.0
- **修改日期**: 2025-10-09
- **作者**: GitHub Copilot
- **狀態**: ✅ 完成並測試通過
- **重大變更**: 添加嵌入模式支持,保持向後兼容

---

## 總結

通過添加 `embedded` 屬性,我們成功實現了:

✅ **獨立模式** - 保持原本的完整設計(左側導航 80px + 上方工具欄 + 主編輯區 + 右側面板 320px)

✅ **嵌入模式** - 按照專案頁面需求設計(主編輯區 + 右側屬性編輯面板)

✅ **代碼重用** - 單一組件支持兩種模式,無需維護多個版本

✅ **向後兼容** - 現有獨立頁面無需修改,自動使用獨立模式

✅ **清晰明確** - CSS class 和屬性命名清楚,易於理解

這次修改解決了之前將所有樹狀圖都簡化的問題,現在可以根據使用場景選擇合適的布局模式! 🎉
