# 快速除錯指南

## 問題：無法新增節點或儲存變更

### 🔍 除錯步驟

#### 1. 檢查前後端是否正常運行

**檢查後端：**
```bash
curl http://localhost:3020/api/health
```
應該回傳：`{"status":"ok","timestamp":"..."}`

**檢查前端：**
在瀏覽器開啟：http://localhost:3030/?view=sdd-mindmap

---

#### 2. 開啟瀏覽器開發者工具

按 `F12` 或 `Cmd+Option+I` (Mac)

##### Console 標籤
應該看到這些日誌：
```
📍 Loading saved layout from server: 27 nodes  ← 載入成功
```

如果看到錯誤，請截圖。

##### Network 標籤
1. 篩選：`XHR` 或 `Fetch`
2. 執行操作（新增節點、拖曳等）
3. 檢查是否有請求：
   - `GET /api/mindmap/layout/sdd-mindmap` ← 載入
   - `POST /api/mindmap/layout/sdd-mindmap` ← 保存

如果沒有 POST 請求，代表保存邏輯沒有觸發。

---

#### 3. 測試新增節點

**步驟：**
1. 在任一節點上**按右鍵**
2. 點擊「➕ 新增子節點」
3. 觀察 Console

**預期 Console 輸出：**
```
🆕 Adding new node to parent: root          ← 開始新增
✅ Node added, saving layout...             ← 新增完成
✅ Layout saved to server                   ← 保存成功
```

**如果沒有任何輸出：**
- 檢查右鍵選單是否正確顯示
- 檢查是否有 JavaScript 錯誤（紅色文字）

**如果只有第一行輸出：**
- `addNode` 函數的回調沒有執行
- 可能是 `useMindMap` hook 的問題

**如果前兩行輸出但沒有第三行：**
- `handleNodesChange` 沒有被呼叫
- 或後端保存失敗

---

#### 4. 測試拖曳保存

**步驟：**
1. 拖曳任一節點
2. 放開滑鼠
3. 觀察 Console

**預期 Console 輸出：**
```
✅ Layout saved to server
```

**如果沒有輸出：**
- 檢查 Network 是否有 POST 請求
- 檢查後端終端是否收到請求

---

#### 5. 檢查後端終端

應該看到：
```
POST /api/mindmap/layout/sdd-mindmap 200 1.234 ms - 93
```

**如果沒有：**
- 前端沒有發送請求
- 檢查前端 Console 是否有錯誤

**如果是 500 錯誤：**
- 後端處理失敗
- 檢查後端終端的錯誤訊息

---

#### 6. 驗證資料是否保存

```bash
# 查看檔案是否存在
ls -la data/sdd-mindmap-layout.json

# 查看檔案內容
cat data/sdd-mindmap-layout.json | head -20

# 查看檔案最後修改時間
stat data/sdd-mindmap-layout.json
```

**如果檔案不存在：**
- POST 請求沒有成功
- 或後端保存邏輯有問題

**如果檔案存在但是舊的：**
- 後端收到請求但沒有寫入
- 檢查檔案權限

---

#### 7. 測試樣式編輯

**步驟：**
1. 右鍵點擊節點
2. 選擇「🎨 編輯節點樣式」
3. 調整任何設定
4. 點擊「儲存」
5. 觀察 Console

**預期輸出：**
```
✅ Layout saved to server
```

---

## 🐛 常見問題

### Q1: 右鍵選單沒有出現
**可能原因：**
- 沒有按右鍵（試試 Ctrl+點擊 on Mac）
- JavaScript 載入失敗
- React 元件沒有渲染

**解決方法：**
1. 重新整理頁面（Cmd+Shift+R 硬重新整理）
2. 清除瀏覽器快取
3. 檢查 Console 是否有錯誤

---

### Q2: Console 沒有任何輸出
**可能原因：**
- `console.log` 被過濾掉了
- JavaScript 執行失敗

**解決方法：**
1. 檢查 Console 的過濾設定（應該顯示 All levels）
2. 檢查是否有紅色錯誤訊息
3. 重新載入頁面

---

### Q3: POST 請求一直失敗（紅色）
**可能原因：**
- 後端沒有運行
- CORS 問題
- 網路問題

**解決方法：**
1. 檢查後端是否運行：`curl http://localhost:3020/api/health`
2. 重啟後端：`npm run dev:server`
3. 檢查 Network 標籤的錯誤訊息

---

### Q4: 重新整理後變更消失
**可能原因：**
- POST 請求沒有成功
- 檔案沒有寫入
- 載入邏輯有問題

**解決方法：**
1. 檢查 `data/sdd-mindmap-layout.json` 檔案
2. 檢查檔案修改時間是否是最新的
3. 檢查 GET 請求是否成功載入資料

---

### Q5: 新增節點但畫面沒有變化
**可能原因：**
- React 狀態沒有更新
- `addNode` 函數有問題
- 節點被渲染在畫面外

**解決方法：**
1. 檢查 Console 是否有 "🆕 Adding new node" 訊息
2. 縮小畫面（捲動或縮放）尋找新節點
3. 檢查 React DevTools 中的 state

---

## 🔧 如果還是不行...

### 完全重啟

```bash
# 1. 停止所有服務（在終端按 Ctrl+C）

# 2. 清除快取和重新安裝
rm -rf node_modules package-lock.json
npm install

# 3. 刪除保存的資料（重新開始）
rm data/sdd-mindmap-layout.json

# 4. 重新啟動後端
npm run dev:server

# 5. 在另一個終端啟動前端
npm run dev:client

# 6. 在瀏覽器硬重新整理
# Mac: Cmd+Shift+R
# Windows/Linux: Ctrl+Shift+R
```

---

## 📝 回報問題時請提供

1. **Console 截圖**（包含所有訊息）
2. **Network 標籤截圖**（顯示請求）
3. **後端終端輸出**（最後 20 行）
4. **檔案檢查結果**
   ```bash
   ls -la data/
   tail -10 data/sdd-mindmap-layout.json
   ```
5. **具體操作步驟**（做了什麼動作）
6. **預期結果 vs 實際結果**

這樣才能快速找出問題！
