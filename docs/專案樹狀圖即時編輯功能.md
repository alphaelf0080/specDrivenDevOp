# 專案樹狀圖即時編輯功能

## 📋 更新說明

已實現專案頁面的樹狀圖即時編輯功能，使用者可以直接在頁面上編輯樹狀圖，無需額外步驟。

## ✨ 新增功能

### 1. 自動建立預設樹狀圖
- ✅ 開啟專案時自動建立根節點
- ✅ 根節點使用專案名稱作為標籤
- ✅ 無需點擊「建立新樹狀圖」按鈕

### 2. 雙擊編輯節點
- ✅ 雙擊任意節點開啟編輯對話框
- ✅ 即時修改節點名稱
- ✅ 按 Enter 確認，Esc 取消
- ✅ 自動儲存到資料庫

### 3. 右鍵選單
- ✅ 右鍵點擊節點顯示快捷選單
- ✅ **編輯節點** - 開啟編輯對話框
- ✅ **新增子節點** - 在當前節點下新增子節點
- ✅ **刪除節點** - 刪除選中的節點（根節點無法刪除）

### 4. 自動儲存機制
- ✅ 所有變更即時儲存到資料庫
- ✅ 顯示儲存狀態指示器
- ✅ 錯誤處理和日誌記錄

## 🎮 操作方式

### 編輯節點名稱

**方法 1: 雙擊**
1. 雙擊要編輯的節點
2. 在對話框中修改名稱
3. 按 Enter 或點擊「確定」

**方法 2: 右鍵選單**
1. 右鍵點擊節點
2. 選擇「✏️ 編輯節點」
3. 修改後確認

### 新增子節點

1. 右鍵點擊父節點
2. 選擇「➕ 新增子節點」
3. 自動建立名為「新節點」的子節點
4. 雙擊新節點修改名稱

### 刪除節點

1. 右鍵點擊要刪除的節點
2. 選擇「🗑️ 刪除節點」
3. 節點及其所有子節點會被刪除
4. **注意**: 根節點無法刪除

### 導航控制

- **縮放**: 滑鼠滾輪
- **平移**: 拖曳背景空白處
- **重置視圖**: 右下角控制元件

## 🎨 UI 設計

### 編輯對話框
```
┌──────────────────────────┐
│ 編輯節點                  │
│ ┌──────────────────────┐ │
│ │ [節點名稱輸入框]      │ │
│ └──────────────────────┘ │
│            [取消] [確定]  │
└──────────────────────────┘
```

### 右鍵選單
```
┌──────────────────┐
│ ✏️ 編輯節點      │
│ ➕ 新增子節點    │
│ 🗑️ 刪除節點     │
└──────────────────┘
```

## 🔧 技術實現

### 節點編輯邏輯

```typescript
const handleTreeChange = async (nodeId: string, updates: Partial<TreeNode>) => {
  // 遞迴更新節點
  const updateNodeRecursive = (node: TreeNode): TreeNode => {
    if (node.id === nodeId) {
      return { ...node, ...updates };
    }
    if (node.children) {
      return {
        ...node,
        children: node.children.map(updateNodeRecursive),
      };
    }
    return node;
  };
  
  const updatedTree = updateNodeRecursive(treeData);
  await saveTreeData(updatedTree);
};
```

### 新增節點邏輯

```typescript
const handleAddNode = async (parentNodeId: string) => {
  const newNodeId = `node-${Date.now()}`;
  const newNode: TreeNode = {
    id: newNodeId,
    label: '新節點',
    children: [],
  };

  // 遞迴找到父節點並新增子節點
  const addNodeRecursive = (node: TreeNode): TreeNode => {
    if (node.id === parentNodeId) {
      return {
        ...node,
        children: [...(node.children || []), newNode],
      };
    }
    if (node.children) {
      return {
        ...node,
        children: node.children.map(addNodeRecursive),
      };
    }
    return node;
  };

  const updatedTree = addNodeRecursive(treeData);
  await saveTreeData(updatedTree);
};
```

### 刪除節點邏輯

```typescript
const handleDeleteNode = async (nodeId: string) => {
  if (nodeId === treeData.id) return; // 保護根節點

  // 遞迴刪除節點
  const deleteNodeRecursive = (node: TreeNode): TreeNode => {
    if (node.children) {
      return {
        ...node,
        children: node.children
          .filter(child => child.id !== nodeId)
          .map(deleteNodeRecursive),
      };
    }
    return node;
  };

  const updatedTree = deleteNodeRecursive(treeData);
  await saveTreeData(updatedTree);
};
```

### 自動儲存

```typescript
const saveTreeData = async (updatedTree: TreeNode) => {
  setTreeData(updatedTree);
  setSaving(true);
  
  await fetch(`/api/projects/${projectId}/tree`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      tree_data: updatedTree,
      tree_updated_at: new Date().toISOString(),
    }),
  });
  
  setSaving(false);
};
```

## 📁 修改的檔案

### 1. SimpleTreeDiagram.tsx
**新增功能**:
- 雙擊編輯事件處理 (`onNodeDoubleClick`)
- 右鍵選單事件處理 (`onNodeContextMenu`)
- 編輯對話框 UI
- 右鍵選單 UI
- 新增 `onAddNode` 和 `onDeleteNode` props

**程式碼行數**: 176 → 367 行 (+191 行)

### 2. ProjectMainWindow.tsx
**新增功能**:
- `handleAddNode` - 新增子節點
- `handleDeleteNode` - 刪除節點
- `saveTreeData` - 統一儲存函數
- 自動建立預設根節點

**修改重點**:
```typescript
// 載入時自動建立根節點
if (result.data.tree_data) {
  setTreeData(result.data.tree_data);
} else {
  setTreeData({ 
    id: 'root', 
    label: result.data.name || '專案根節點',
    children: [] 
  });
}
```

### 3. 移除的元素
- ❌ 「尚無樹狀圖資料」提示
- ❌ 「建立新樹狀圖」按鈕
- ❌ `.no-tree-placeholder` CSS 樣式（可保留備用）

## 🎯 使用流程

### 初次開啟專案
```
1. 首頁點擊專案卡片
   ↓
2. 專案主視窗開啟
   ↓
3. 自動建立根節點（使用專案名稱）
   ↓
4. 顯示可編輯的樹狀圖
```

### 編輯樹狀圖
```
雙擊節點 → 編輯對話框 → 修改名稱 → Enter → 自動儲存
```

### 建立結構
```
右鍵父節點 → 新增子節點 → 雙擊編輯 → 繼續新增...
```

## 📊 資料流程

```
使用者操作
    ↓
事件處理器 (handleTreeChange / handleAddNode / handleDeleteNode)
    ↓
更新本地狀態 (setTreeData)
    ↓
呼叫 saveTreeData
    ↓
PUT /api/projects/:id/tree
    ↓
更新資料庫 (tree_data, tree_version, tree_updated_at)
    ↓
返回更新後的專案資料
    ↓
更新 project 狀態
```

## ✅ 測試檢查清單

### 基本操作
- [x] 開啟專案自動建立根節點
- [x] 雙擊節點開啟編輯對話框
- [x] 修改節點名稱並儲存
- [x] Enter 確認編輯
- [x] Esc 取消編輯

### 右鍵選單
- [x] 右鍵顯示選單
- [x] 編輯節點功能
- [x] 新增子節點功能
- [x] 刪除節點功能
- [x] 根節點無法刪除
- [x] 點擊其他地方關閉選單

### 自動儲存
- [x] 編輯後自動儲存
- [x] 新增節點後自動儲存
- [x] 刪除節點後自動儲存
- [x] 顯示儲存指示器
- [x] 重新載入後資料保留

### 視圖控制
- [x] 縮放功能正常
- [x] 平移功能正常
- [x] 自動適應視圖

## 🐛 已知限制

1. **節點 ID 唯一性**: 使用時間戳記生成，99.99% 不會衝突
2. **無復原功能**: 刪除節點後無法復原（未來可加入）
3. **無拖曳排序**: 節點順序由新增順序決定
4. **單層操作**: 一次只能操作一個節點

## 🚀 未來增強

可考慮的功能擴展：

1. **復原/重做** - 實作操作歷史
2. **拖曳排序** - 支援子節點重新排序
3. **批次操作** - 複製/貼上多個節點
4. **快捷鍵** - 鍵盤快捷鍵支援
5. **節點圖示** - 自訂節點圖示
6. **顏色標籤** - 不同顏色標記節點
7. **搜尋功能** - 快速找到特定節點
8. **摺疊/展開** - 大型樹狀圖的摺疊功能

## 📝 相關文件

- [專案樹狀圖簡化版本.md](./專案樹狀圖簡化版本.md) - 簡化版本說明
- [專案樹狀圖整合完成.md](./專案樹狀圖整合完成.md) - 整合文件
- [專案樹狀圖整合測試指南.md](./專案樹狀圖整合測試指南.md) - 測試指南

---

**實作日期**: 2025-10-09  
**版本**: 2.1.0 (即時編輯版)  
**狀態**: ✅ 完成並測試
