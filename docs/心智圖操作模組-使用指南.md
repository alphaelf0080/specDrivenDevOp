# 心智圖操作模組 - 使用指南

## 功能概覽

心智圖操作模組提供了完整的右鍵選單功能，讓你可以輕鬆地編輯和管理心智圖。

## 核心功能

### 1. 右鍵選單 (ContextMenu)

在不同的位置按右鍵會顯示不同的選單：

#### 📍 在節點上按右鍵
- ➕ **新增子節點**：在當前節點下創建新的子節點
- 🔗 **連接到其他節點**：建立與其他節點的連接
- 🎨 **編輯節點樣式**：開啟樣式編輯器自訂節點外觀
- 🗑️ **刪除節點**：刪除當前節點及其所有連接

#### 📍 在連接線上按右鍵
- 🎨 **編輯連接線樣式**：自訂連接線的顏色、寬度、樣式
- 🔓 **解除連接**：中斷兩個節點之間的連接
- 🗑️ **刪除連接線**：移除連接線

#### 📍 在空白處按右鍵
- ✖️ **取消**：關閉選單

### 2. 節點樣式編輯器 (NodeStyleEditor)

點擊「編輯節點樣式」後會開啟完整的樣式編輯器：

#### 🎨 快速配色
提供 6 種預設配色方案：
- 藍色系（專業、信任）
- 綠色系（成功、成長）
- 黃色系（警告、注意）
- 紅色系（重要、緊急）
- 紫色系（創意、優雅）
- 灰色系（中性、沉穩）

#### 🎛️ 自訂顏色
- **背景顏色**：節點的背景色
- **邊框顏色**：節點的邊框色
- **文字顏色**：節點內文字的顏色

#### 📏 尺寸調整
- **邊框寬度**：0-10px，拖動滑桿調整
- **文字大小**：10-24px，調整文字顯示大小
- **圓角**：0-24px，設定節點的圓角程度

#### 👁️ 即時預覽
在編輯時可以即時看到樣式效果

### 3. 連接線樣式編輯器 (EdgeStyleEditor)

點擊「編輯連接線樣式」後可以自訂連接線：

#### 🎨 線條設定
- **線條顏色**：選擇任意顏色
- **線條寬度**：1-10px

#### 📐 線條樣式
- **實線**：標準連續線條
- **虛線**：短虛線樣式
- **點線**：點狀虛線
- **長虛線**：較長的虛線間隔
- **點劃線**：點與線的組合

#### 🔄 連接線類型
- **預設**：標準貝茲曲線
- **平滑**：平滑的階梯式連接
- **直線**：直線連接
- **階梯**：垂直水平階梯式

#### ✨ 動畫效果
勾選「啟用動畫效果」讓連接線動起來

## 使用方式

### 基本操作

1. **拖曳節點**
   - 直接點擊並拖曳節點到想要的位置
   - 釋放後自動儲存位置到後端

2. **新增節點**
   - 在父節點上按右鍵
   - 選擇「➕ 新增子節點」
   - 新節點會自動連接到父節點

3. **編輯樣式**
   - 在節點/連接線上按右鍵
   - 選擇「🎨 編輯樣式」
   - 調整所需參數
   - 點擊「儲存」

4. **刪除元素**
   - 在節點/連接線上按右鍵
   - 選擇「🗑️ 刪除」
   - 確認刪除（不可復原）

### 快捷鍵

- **ESC**：關閉右鍵選單或編輯器
- **點擊選單外部**：關閉選單

## 技術架構

### 元件結構

```
SDDMindMap (主元件)
  └─ MindMapCanvas (畫布)
      ├─ ReactFlow (流程圖引擎)
      ├─ ContextMenu (右鍵選單)
      ├─ NodeStyleEditor (節點樣式編輯器)
      └─ EdgeStyleEditor (連接線樣式編輯器)
```

### 檔案列表

- `ContextMenu.tsx` - 右鍵選單元件
- `ContextMenu.css` - 右鍵選單樣式
- `NodeStyleEditor.tsx` - 節點樣式編輯器
- `EdgeStyleEditor.tsx` - 連接線樣式編輯器
- `StyleEditor.css` - 樣式編輯器共用樣式
- `MindMapCanvas.tsx` - 整合所有功能的畫布元件

### 資料流

```
使用者操作
  → 右鍵選單觸發
  → 選擇操作類型
  → 開啟對應編輯器（如需要）
  → 執行操作
  → 更新 React 狀態
  → 自動保存到後端 API
  → 渲染更新
```

## API 整合

所有變更會自動通過以下流程保存：

1. 操作觸發（新增/刪除/樣式變更）
2. 更新本地 React 狀態
3. 呼叫 `onNodesChange` / `onEdgesChange`
4. 發送 POST 請求到 `/api/mindmap/layout/:id`
5. 後端保存到 `/data/:id-layout.json`

## 自訂擴展

### 新增自訂配色

在 `NodeStyleEditor.tsx` 修改 `presetColors` 陣列：

```typescript
const presetColors = [
  { name: '自訂色', bg: '#fff0f0', border: '#ff6b6b', text: '#c92a2a' },
  // ... 其他配色
];
```

### 新增線條樣式

在 `EdgeStyleEditor.tsx` 修改 `dashPatterns` 陣列：

```typescript
const dashPatterns = [
  { name: '自訂樣式', value: '15 3 3 3' },
  // ... 其他樣式
];
```

### 自訂右鍵選單項目

在 `ContextMenu.tsx` 的 JSX 中新增按鈕：

```tsx
<button
  className="context-menu-item"
  onClick={() => handleMenuClick(() => onCustomAction(selectedNode.id))}
>
  <span className="context-menu-icon">🌟</span>
  <span>自訂動作</span>
</button>
```

## 注意事項

⚠️ **重要提醒**

1. **刪除操作不可復原**：刪除節點或連接線前請確認
2. **自動保存**：所有變更會立即保存，無需手動儲存
3. **瀏覽器相容性**：建議使用現代瀏覽器（Chrome、Firefox、Safari、Edge）
4. **效能考量**：大型心智圖（超過100個節點）可能影響效能

## 常見問題

### Q: 右鍵選單沒有出現？
A: 確認你按的是「右鍵」（或在 Mac 上使用 Ctrl+點擊），而不是左鍵。

### Q: 樣式變更沒有保存？
A: 確認後端服務正在運行（port 3020），並檢查瀏覽器控制台是否有錯誤。

### Q: 刪除節點後能復原嗎？
A: 目前刪除操作不可復原，建議在刪除前再次確認。可以透過「重置布局」回到預設狀態。

### Q: 如何批次修改多個節點的樣式？
A: 目前只支援單個節點編輯。如需批次操作，可以：
   1. 使用快速配色快速套用相同風格
   2. 手動複製樣式設定值逐一套用

## 未來計劃

- [ ] 批次操作（多選節點）
- [ ] 復原/重做功能
- [ ] 節點標籤編輯
- [ ] 匯出為圖片
- [ ] 節點搜尋功能
- [ ] 折疊/展開子樹
- [ ] 快捷鍵支援

## 相關文件

- [SDD+AI 開發方案計劃書](../docs/SDD+AI-開發方案計劃書.md)
- [後端 API 文件](../data/README.md)
- [ReactFlow 官方文件](https://reactflow.dev/)

---

💡 **提示**：這個模組設計為可重用元件，可以輕鬆整合到其他專案中！
